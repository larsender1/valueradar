<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ValueRadar Pro - Dashboard</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        teal: { 400: '#2dd4bf', 500: '#14b8a6', 600: '#0d9488', 900: '#134e4a' },
                        slate: { 800: '#1e293b', 900: '#0f172a' }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #0b0f19;
            color: #e2e8f0;
            font-family: 'Inter', sans-serif;
        }

        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #1e293b;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #334155;
        }

        .glass-card {
            background: rgba(17, 24, 39, 0.4);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .glass-card:hover {
            border-color: rgba(20, 184, 166, 0.3);
            background: rgba(17, 24, 39, 0.6);
            transform: translateY(-1px);
        }

        .glass-header {
            background: rgba(11, 15, 25, 0.9);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .bg-grid-pattern {
            background-size: 40px 40px;
            background-image: linear-gradient(to right, rgba(255, 255, 255, 0.02) 1px, transparent 1px),
                linear-gradient(to bottom, rgba(255, 255, 255, 0.02) 1px, transparent 1px);
            mask-image: linear-gradient(to bottom, black 40%, transparent 100%);
        }

        .wl-item {
            border-bottom: 1px solid rgba(255, 255, 255, 0.03);
            transition: background 0.2s;
        }

        .wl-item:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        .wl-item.active {
            background: rgba(20, 184, 166, 0.05);
            border-left: 3px solid #14b8a6;
        }

        .wl-badge {
            background: rgba(255, 255, 255, 0.1);
            color: #94a3b8;
            font-size: 10px;
            padding: 1px 4px;
            border-radius: 3px;
        }

        .chart-btn {
            padding: 4px 10px;
            font-size: 11px;
            font-weight: 600;
            color: #94a3b8;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .chart-btn:hover {
            color: white;
            background: rgba(255, 255, 255, 0.05);
        }

        .chart-btn.active {
            background: #0d9488;
            color: white;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        .apexcharts-tooltip {
            background: #1e293b !important;
            border-color: #334155 !important;
            color: #fff;
        }

        .apexcharts-tooltip-title {
            background: #0f172a !important;
            border-bottom-color: #1e293b !important;
        }
    </style>
</head>

<body class="h-screen flex overflow-hidden selection:bg-teal-500/30 selection:text-white">
    <div class="fixed inset-0 bg-grid-pattern pointer-events-none z-0"></div>

    <!-- SIDEBAR -->
    <aside class="w-80 border-r border-slate-800/50 bg-[#080b14] flex flex-col z-20 relative h-full">
        <div class="h-16 flex items-center px-6 gap-3 shrink-0">
            <div class="bg-teal-600 text-white font-bold px-2 py-0.5 rounded text-xs shadow-lg shadow-teal-900/50">VR
            </div>
            <span class="font-bold text-lg tracking-tight text-white">
                ValueRadar <span class="text-teal-500 text-xs">PRO</span>
            </span>
        </div>

        <div class="px-5 pt-4 shrink-0">
            <div class="flex bg-[#111621] rounded-lg p-1 border border-slate-800 w-full justify-between">
                <button onclick="filterStocks('ALL')"
                    class="region-btn flex-1 py-1 text-[10px] font-bold rounded hover:text-white transition text-slate-400 active-region"
                    data-reg="ALL">All</button>
                <button onclick="filterStocks('US')"
                    class="region-btn flex-1 py-1 text-[10px] font-bold text-slate-400 hover:text-white transition"
                    data-reg="US">US</button>
                <button onclick="filterStocks('DE')"
                    class="region-btn flex-1 py-1 text-[10px] font-bold text-slate-400 hover:text-white transition"
                    data-reg="DE">DE</button>
                <button onclick="filterStocks('FAV')"
                    class="region-btn flex-1 py-1 text-[10px] font-bold text-slate-400 hover:text-white transition border-l border-white/5 ml-1"
                    data-reg="FAV">List</button>
            </div>
        </div>

        <div class="px-5 pt-4 pb-2 shrink-0">
            <div class="flex justify-between items-center mb-1">
                <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest"
                    id="watchlist-count">Watchlist</span>
                <div class="flex gap-2">
                    <button
                        class="text-[9px] bg-slate-800 text-slate-400 px-2 py-0.5 rounded hover:text-white transition"
                        onclick="toggleTheme()">Theme</button>
                    <button class="text-slate-400 hover:text-white" onclick="addSymbolToWatchlist()"
                        title="Add Symbol">+</button>
                </div>
            </div>
            <div class="relative mt-2">
                <input type="text" id="watchlist-search" onkeyup="filterStocksByName(this.value)"
                    placeholder="Filter by name or ticker..."
                    class="w-full bg-[#111621] text-xs rounded border border-slate-800 px-3 py-2 text-slate-300 focus:outline-none focus:border-slate-600 transition placeholder-slate-600">
            </div>
        </div>

        <div id="watchlist-container" class="flex-1 overflow-y-auto mt-2">
            <div class="p-4 text-center text-xs text-slate-500">Loading stocks...</div>
        </div>

        <div class="p-3 text-[10px] text-slate-600 text-center border-t border-slate-800 shrink-0">
            User: <span class="text-teal-500">{{ username }}</span> • Powered by Python Scan
        </div>
    </aside>

    <!-- MAIN -->
    <main class="flex-1 flex flex-col relative overflow-hidden z-10 w-full h-full">

        <!-- HEADER -->
        <header class="h-20 glass-header flex items-center justify-between px-6 lg:px-10 sticky top-0 z-30 shrink-0">
            <div class="min-w-0">
                <h1 class="text-2xl md:text-3xl font-bold text-white tracking-tight flex items-center gap-3 truncate">
                    <span id="header-name">Loading...</span>
                    <span id="header-ticker"
                        class="text-sm font-medium text-slate-400 bg-slate-800/50 px-2 py-1 rounded border border-slate-700/50">---</span>
                </h1>
                <div class="flex items-center gap-2 mt-1 text-xs text-slate-400">
                    <span id="header-sector">Sector</span><span class="text-slate-600">•</span>
                    <span id="header-industry">Industry</span><span class="text-slate-600">•</span>
                    <a id="yahoo-link" href="#" target="_blank"
                        class="text-teal-500 hover:text-teal-400 flex items-center gap-1">Yahoo Finance ↗</a>
                </div>
            </div>

            <div class="flex items-center gap-4 md:gap-6 shrink-0">

                <!-- EN/DE Toggle -->
                <button id="lang-toggle"
                    class="text-[10px] font-bold px-2 py-1 rounded border border-slate-700 bg-slate-900 text-slate-300 hover:bg-slate-800">
                    EN
                </button>

                <!-- VR SCORE -->
                <div class="flex flex-col items-end hidden sm:flex">
                    <div class="flex items-center gap-2">
                        <span class="text-[10px] text-slate-400 uppercase font-bold tracking-wider"
                            data-i18n="label-vr-score">VR Score</span>
                        <div
                            class="flex items-center justify-center bg-teal-500/10 border border-teal-500/50 rounded px-2 py-0.5">
                            <span id="header-score" class="text-lg font-bold text-teal-400">--</span>
                        </div>
                    </div>
                    <span id="header-score-text"
                        class="text-[9px] text-teal-600 font-bold uppercase tracking-widest mt-0.5">Checking</span>
                </div>

                <!-- PRICE + LOGOUT -->
                <div class="flex items-center gap-4 border-l border-white/10 pl-4 md:pl-6">
                    <div class="text-right">
                        <div id="header-price"
                            class="text-3xl md:text-4xl font-bold text-white tracking-tight whitespace-nowrap">--</div>
                        <div class="text-sm text-teal-400 font-medium flex items-center justify-end gap-1">
                            <span class="relative flex h-2 w-2 mr-1">
                                <span
                                    class="animate-ping absolute inline-flex h-full w-full rounded-full bg-teal-400 opacity-75"></span>
                                <span class="relative inline-flex rounded-full h-2 w-2 bg-teal-500"></span>
                            </span>
                            Live Price
                        </div>
                    </div>
                    <a href="/logout"
                        class="text-[11px] font-semibold px-3 py-1 rounded-lg border border-red-500/60 text-red-300 hover:bg-red-500/10">
                        Logout
                    </a>
                </div>
            </div>
        </header>

        <!-- CONTENT -->
        <div class="flex-1 overflow-y-auto p-4 lg:p-10 scroll-smooth pb-32">
            <div class="max-w-7xl mx-auto space-y-6">

                <!-- CHART -->
                <section class="glass-card rounded-xl p-4 md:p-6">
                    <div class="flex justify-between items-center mb-4 flex-wrap gap-4">
                        <div class="flex items-center gap-2">
                            <h2 class="text-lg font-bold text-white flex items-center gap-2"
                                data-i18n="label-price-action">
                                <i data-lucide="activity" class="w-5 h-5 text-teal-500"></i>
                                Price Action
                            </h2>
                            <span id="tf-perf"
                                class="text-xs text-teal-400 font-bold bg-teal-500/10 px-2 py-0.5 rounded">---</span>
                        </div>

                        <div class="flex items-center gap-2 flex-wrap">
                            <div class="flex bg-slate-800/50 rounded-md p-1 border border-white/5">
                                <button onclick="updateTimeframe('1W')" data-tf="1W"
                                    class="tf-btn chart-btn">1W</button>
                                <button onclick="updateTimeframe('1M')" data-tf="1M"
                                    class="tf-btn chart-btn">1M</button>
                                <button onclick="updateTimeframe('1Y')" data-tf="1Y"
                                    class="tf-btn chart-btn">1J</button>
                                <button onclick="updateTimeframe('5Y')" data-tf="5Y"
                                    class="tf-btn chart-btn">5Y</button>
                                <button onclick="updateTimeframe('MAX')" data-tf="MAX"
                                    class="tf-btn chart-btn active">MAX</button>
                            </div>

                            <div class="flex bg-slate-800/50 rounded-md p-1 border border-white/5 hidden sm:flex">
                                <button onclick="toggleMA('20')" data-ma="20" class="ma-btn chart-btn active">MA
                                    20</button>
                                <button onclick="toggleMA('50')" data-ma="50" class="ma-btn chart-btn">MA 50</button>
                                <button onclick="toggleMA('200')" data-ma="200" class="ma-btn chart-btn">MA 200</button>
                            </div>

                            <div class="flex bg-slate-800/50 rounded-md p-1 border border-white/5 hidden sm:flex">
                                <button onclick="setChartType('line')" data-ctype="line"
                                    class="charttype-btn chart-btn active">Line</button>
                                <button onclick="setChartType('candles')" data-ctype="candles"
                                    class="charttype-btn chart-btn">Candles</button>
                            </div>
                        </div>
                    </div>

                    <div id="chart" class="h-[430px] w-full pb-2"></div>
                </section>

                <!-- COMPANY DESCRIPTION (eigene Karte unter dem Chart) -->
                <section class="glass-card rounded-xl p-4 md:p-6">
                    <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-2"
                        data-i18n="label-company-desc">
                        Company Description
                    </h3>
                    <p id="company-desc" class="text-xs md:text-sm text-slate-300 leading-relaxed">
                        Loading description...
                    </p>
                </section>

                <!-- KPIs -->
                <section class="grid grid-cols-1 gap-4">

                    <!-- MARKET CAP -->
                    <div
                        class="glass-card rounded-lg p-5 border-l-4 border-l-teal-500 bg-gradient-to-r from-teal-900/10 to-transparent flex flex-col md:flex-row md:items-center md:justify-between gap-4 group">
                        <div>
                            <div class="flex items-center justify-between mb-2">
                                <div class="p-2 bg-teal-500/10 rounded-lg text-teal-400">
                                    <i data-lucide="dollar-sign" class="w-5 h-5"></i>
                                </div>
                                <span
                                    class="text-[9px] text-teal-300 bg-teal-500/20 px-2 py-0.5 rounded border border-teal-500/30"
                                    data-i18n="label-kpi-size">Size</span>
                            </div>
                            <div class="text-xs font-bold text-teal-400 uppercase tracking-widest mb-1"
                                data-i18n="label-market-cap">Market Cap</div>
                            <div id="val-mcap" class="text-2xl font-bold text-white tracking-tight">--</div>
                        </div>
                        <div class="hidden md:block md:w-1/2">
                            <div class="h-10 w-full rounded-md bg-slate-900/70 overflow-hidden relative">
                                <div
                                    class="absolute inset-0 opacity-60 bg-gradient-to-r from-teal-500/10 via-teal-400/40 to-teal-500/10">
                                </div>
                                <div class="absolute inset-x-0 inset-y-1/2 border-t border-slate-700/60"></div>
                            </div>
                            <p class="text-[10px] text-slate-500 mt-2" data-i18n="hint-market-cap">
                                Indicative market size (visual only).
                            </p>
                        </div>
                    </div>

                    <!-- P/E -->
                    <div
                        class="glass-card rounded-lg p-5 border-l-4 border-l-slate-700 hover:border-l-teal-500 transition group flex flex-col md:flex-row md:items-center md:justify-between gap-4 relative overflow-hidden">
                        <div class="md:w-1/2">
                            <div class="flex items-center justify-between mb-2">
                                <div
                                    class="p-2 bg-slate-800 rounded-lg text-slate-400 group-hover:text-white transition">
                                    <i data-lucide="bar-chart-2" class="w-5 h-5"></i>
                                </div>
                                <span id="badge-pe-rating"
                                    class="text-[9px] text-slate-400 bg-slate-800 px-2 py-0.5 rounded">--</span>
                            </div>
                            <div class="text-xs font-bold text-slate-400 group-hover:text-white uppercase tracking-widest mb-1 transition"
                                data-i18n="label-pe">P/E Ratio</div>
                            <div id="val-pe" class="text-2xl font-bold text-white tracking-tight">--</div>
                            <div class="text-[10px] text-slate-500 mt-1" id="sub-pe">PEG: --</div>
                        </div>
                        <div class="md:w-1/2">
                            <div class="text-[10px] text-slate-500 mb-1" data-i18n="label-valuation-band">
                                Valuation band
                            </div>
                            <div class="w-full bg-slate-900 h-2 rounded-full overflow-hidden">
                                <div id="pe-range-fill"
                                    class="bg-gradient-to-r from-teal-500 via-yellow-400 to-red-500 h-full w-0 transition-all duration-700">
                                </div>
                            </div>
                            <div class="flex justify-between text-[9px] text-slate-500 mt-1">
                                <span data-i18n="label-cheap">Cheap</span>
                                <span data-i18n="label-fair">Fair</span>
                                <span data-i18n="label-expensive">Expensive</span>
                            </div>
                        </div>
                    </div>

                    <!-- PROFIT MARGIN -->
                    <div
                        class="glass-card rounded-lg p-5 border-l-4 border-l-slate-700 hover:border-l-teal-500 transition group flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                        <div class="md:w-1/2">
                            <div class="flex items-center justify-between mb-2">
                                <div
                                    class="p-2 bg-slate-800 rounded-lg text-slate-400 group-hover:text-white transition">
                                    <i data-lucide="pie-chart" class="w-5 h-5"></i>
                                </div>
                            </div>
                            <div class="text-xs font-bold text-slate-400 group-hover:text-white uppercase tracking-widest mb-1 transition"
                                data-i18n="label-profit-margin">Profit Margin</div>
                            <div id="val-margin" class="text-2xl font-bold text-white tracking-tight">--%</div>
                        </div>
                        <div class="md:w-1/2">
                            <div class="text-[10px] text-slate-500 mb-1" data-i18n="label-margin-level">
                                Margin level
                            </div>
                            <div class="w-full bg-slate-900 h-2 rounded-full overflow-hidden">
                                <div id="prog-margin" class="bg-teal-500 h-full w-0 transition-all duration-1000"></div>
                            </div>
                        </div>
                    </div>

                    <!-- REVENUE GROWTH -->
                    <div
                        class="glass-card rounded-lg p-5 border-l-4 border-l-slate-700 hover:border-l-teal-500 transition group flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                        <div class="md:w-1/2">
                            <div class="flex items-center justify-between mb-2">
                                <div
                                    class="p-2 bg-slate-800 rounded-lg text-slate-400 group-hover:text-white transition">
                                    <i data-lucide="trending-up" class="w-5 h-5"></i>
                                </div>
                                <span class="text-[9px] text-green-400 font-bold" id="val-growth-badge">--</span>
                            </div>
                            <div class="text-xs font-bold text-slate-400 group-hover:text-white uppercase tracking-widest mb-1 transition"
                                data-i18n="label-rev-growth">Revenue Growth</div>
                            <div id="val-growth" class="text-2xl font-bold text-white tracking-tight">--</div>
                            <div class="text-[10px] text-slate-500 mt-1" data-i18n="label-yoy">Year over year</div>
                        </div>
                        <div class="md:w-1/2">
                            <div class="text-[10px] text-slate-500 mb-1" data-i18n="label-growth-intensity">
                                Growth intensity
                            </div>
                            <div class="w-full bg-slate-900 h-2 rounded-full overflow-hidden">
                                <div id="growth-bar"
                                    class="bg-gradient-to-r from-red-500 via-yellow-400 to-teal-500 h-full w-0 transition-all duration-700">
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- NEWS -->
                <section class="glass-card rounded-xl p-6 flex flex-col">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-sm font-bold text-slate-300 uppercase tracking-widest flex items-center gap-2"
                            data-i18n="label-news">
                            <i data-lucide="newspaper" class="w-4 h-4"></i> Latest News
                        </h3>
                    </div>
                    <div id="news-container" class="space-y-3 overflow-y-auto max-h-[220px] pr-2 scroll-thin">
                        <span class="text-slate-500 text-xs">Loading news...</span>
                    </div>
                </section>

                <!-- SENTIMENT -->
                <section class="glass-card rounded-xl p-6 flex flex-col items-center justify-center relative">
                    <div class="text-[10px] text-slate-400 font-bold uppercase tracking-widest mb-4"
                        data-i18n="label-vr-sentiment">VR Sentiment</div>
                    <div id="gauge-chart" class="w-full h-40"></div>
                    <div class="mt-[-20px] text-center">
                        <div id="sentiment-text" class="text-teal-400 font-bold">Strong Buy</div>
                    </div>
                </section>

                <!-- STRENGTHS / RISKS -->
                <section class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="glass-card rounded-xl p-6">
                        <div class="flex items-center gap-2 mb-4">
                            <div class="p-1.5 bg-green-500/10 rounded-full text-green-400">
                                <i data-lucide="thumbs-up" class="w-4 h-4"></i>
                            </div>
                            <h3 class="text-sm font-bold text-white uppercase tracking-wider"
                                data-i18n="label-strengths">Strengths</h3>
                        </div>
                        <ul id="strengths-list" class="space-y-3">
                            <li class="text-xs text-slate-500">Loading...</li>
                        </ul>
                    </div>

                    <div class="glass-card rounded-xl p-6">
                        <div class="flex items-center gap-2 mb-4">
                            <div class="p-1.5 bg-red-500/10 rounded-full text-red-400">
                                <i data-lucide="alert-triangle" class="w-4 h-4"></i>
                            </div>
                            <h3 class="text-sm font-bold text-white uppercase tracking-wider" data-i18n="label-risks">
                                Risks</h3>
                        </div>
                        <ul id="risks-list" class="space-y-3">
                            <li class="text-xs text-slate-500">Loading...</li>
                        </ul>
                    </div>
                </section>
            </div>
            </section>

            <!-- Extra Fundamentalkennzahlen -->
            <section class="glass-card rounded-xl p-6 mt-4">
                <h3 class="text-xs font-bold text-slate-400 uppercase tracking-[0.25em] mb-4">
                    Zusätzliche Kennzahlen
                </h3>

                <div class="space-y-3 text-xs">

                    <!-- Beta -->
                    <div
                        class="flex items-center justify-between rounded-lg bg-slate-900/40 border border-slate-800 px-4 py-3">
                        <div>
                            <div class="text-[10px] font-semibold text-slate-500 uppercase tracking-widest">
                                Beta
                            </div>
                            <div class="text-[10px] text-slate-500 mt-0.5">
                                Volatilität vs. Markt
                            </div>
                        </div>
                        <div id="kpi-beta" class="text-sm font-semibold text-slate-100">--</div>
                    </div>

                    <!-- Debt / Equity -->
                    <div
                        class="flex items-center justify-between rounded-lg bg-slate-900/40 border border-slate-800 px-4 py-3">
                        <div>
                            <div class="text-[10px] font-semibold text-slate-500 uppercase tracking-widest">
                                Debt / Equity
                            </div>
                            <div class="text-[10px] text-slate-500 mt-0.5">
                                Verschuldungsgrad
                            </div>
                        </div>
                        <div id="kpi-de" class="text-sm font-semibold text-slate-100">--</div>
                    </div>

                    <!-- ROE -->
                    <div
                        class="flex items-center justify-between rounded-lg bg-slate-900/40 border border-slate-800 px-4 py-3">
                        <div>
                            <div class="text-[10px] font-semibold text-slate-500 uppercase tracking-widest">
                                ROE
                            </div>
                            <div class="text-[10px] text-slate-500 mt-0.5">
                                Eigenkapitalrendite
                            </div>
                        </div>
                        <div id="kpi-roe" class="text-sm font-semibold text-slate-100">--</div>
                    </div>

                    <!-- ROIC -->
                    <div
                        class="flex items-center justify-between rounded-lg bg-slate-900/40 border border-slate-800 px-4 py-3">
                        <div>
                            <div class="text-[10px] font-semibold text-slate-500 uppercase tracking-widest">
                                ROIC
                            </div>
                            <div class="text-[10px] text-slate-500 mt-0.5">
                                Rendite auf eingesetztes Kapital
                            </div>
                        </div>
                        <div id="kpi-roic" class="text-sm font-semibold text-slate-100">--</div>
                    </div>

                    <!-- EV / EBITDA -->
                    <div
                        class="flex items-center justify-between rounded-lg bg-slate-900/40 border border-slate-800 px-4 py-3">
                        <div>
                            <div class="text-[10px] font-semibold text-slate-500 uppercase tracking-widest">
                                EV / EBITDA
                            </div>
                            <div class="text-[10px] text-slate-500 mt-0.5">
                                Bewertung im Branchenvergleich
                            </div>
                        </div>
                        <div id="kpi-ev-ebitda" class="text-sm font-semibold text-slate-100">--</div>
                    </div>

                    <!-- EV / Sales -->
                    <div
                        class="flex items-center justify-between rounded-lg bg-slate-900/40 border border-slate-800 px-4 py-3">
                        <div>
                            <div class="text-[10px] font-semibold text-slate-500 uppercase tracking-widest">
                                EV / Sales
                            </div>
                            <div class="text-[10px] text-slate-500 mt-0.5">
                                Bewertung nach Umsatz
                            </div>
                        </div>
                        <div id="kpi-ev-sales" class="text-sm font-semibold text-slate-100">--</div>
                    </div>

                    <!-- Current Ratio -->
                    <div
                        class="flex items-center justify-between rounded-lg bg-slate-900/40 border border-slate-800 px-4 py-3">
                        <div>
                            <div class="text-[10px] font-semibold text-slate-500 uppercase tracking-widest">
                                Current Ratio
                            </div>
                            <div class="text-[10px] text-slate-500 mt-0.5">
                                Kurzfristige Liquidität
                            </div>
                        </div>
                        <div id="kpi-current" class="text-sm font-semibold text-slate-100">--</div>
                    </div>

                    <!-- Quick Ratio -->
                    <div
                        class="flex items-center justify-between rounded-lg bg-slate-900/40 border border-slate-800 px-4 py-3">
                        <div>
                            <div class="text-[10px] font-semibold text-slate-500 uppercase tracking-widest">
                                Quick Ratio
                            </div>
                            <div class="text-[10px] text-slate-500 mt-0.5">
                                Strengere Liquidität
                            </div>
                        </div>
                        <div id="kpi-quick" class="text-sm font-semibold text-slate-100">--</div>
                    </div>

                    <!-- Free Cash Flow -->
                    <div
                        class="flex items-center justify-between rounded-lg bg-slate-900/40 border border-slate-800 px-4 py-3">
                        <div>
                            <div class="text-[10px] font-semibold text-slate-500 uppercase tracking-widest">
                                Free Cash Flow
                            </div>
                            <div class="text-[10px] text-slate-500 mt-0.5">
                                Nach Investitionen verfügbar
                            </div>
                        </div>
                        <div id="kpi-fcf" class="text-sm font-semibold text-slate-100">--</div>
                    </div>

                    <!-- Payout Ratio -->
                    <div
                        class="flex items-center justify-between rounded-lg bg-slate-900/40 border border-slate-800 px-4 py-3">
                        <div>
                            <div class="text-[10px] font-semibold text-slate-500 uppercase tracking-widest">
                                Payout Ratio
                            </div>
                            <div class="text-[10px] text-slate-500 mt-0.5">
                                Dividende vs. Gewinn
                            </div>
                        </div>
                        <div id="kpi-payout" class="text-sm font-semibold text-slate-100">--</div>
                    </div>
                </div>
            </section>


            <div class="text-center text-[10px] text-slate-600 pb-4">
                Data provided for informational purposes only. Not financial advice.
            </div>

        </div>
        </div>
    </main>

    <script>
        lucide.createIcons();

        /* ---------- LANGUAGE TOGGLE ---------- */
        const translations = {
            en: {
                "label-vr-score": "VR Score",
                "label-price-action": "Price Action",
                "label-company-desc": "Company Description",
                "label-kpi-size": "Size",
                "label-market-cap": "Market Cap",
                "hint-market-cap": "Indicative market size (visual only).",
                "label-pe": "P/E Ratio",
                "label-valuation-band": "Valuation band",
                "label-cheap": "Cheap",
                "label-fair": "Fair",
                "label-expensive": "Expensive",
                "label-profit-margin": "Profit Margin",
                "label-margin-level": "Margin level",
                "label-rev-growth": "Revenue Growth",
                "label-yoy": "Year over year",
                "label-growth-intensity": "Growth intensity",
                "label-news": "Latest News",
                "label-vr-sentiment": "VR Sentiment",
                "label-strengths": "Strengths",
                "label-risks": "Risks",
                "label-disclaimer": "Data provided for informational purposes only. Not financial advice."
            },
            de: {
                "label-vr-score": "VR Score",
                "label-price-action": "Kursverlauf",
                "label-company-desc": "UNTERNEHMENSPROFIL",
                "label-kpi-size": "Größe",
                "label-market-cap": "Marktkapitalisierung",
                "hint-market-cap": "Indikative Unternehmensgröße (nur visuell).",
                "label-pe": "KGV",
                "label-valuation-band": "Bewertungsband",
                "label-cheap": "Günstig",
                "label-fair": "Fair",
                "label-expensive": "Teuer",
                "label-profit-margin": "Gewinnmarge",
                "label-margin-level": "Margen-Niveau",
                "label-rev-growth": "Umsatzwachstum",
                "label-yoy": "Year over year",
                "label-growth-intensity": "Wachstumsintensität",
                "label-news": "Aktuelle News",
                "label-vr-sentiment": "VR Sentiment",
                "label-strengths": "Stärken",
                "label-risks": "Risiken",
                "label-disclaimer": "Alle Daten dienen nur Informationszwecken und sind keine Anlageberatung."
            }
        };

        function applyLanguage(lang) {
            const dict = translations[lang] || translations.en;
            document.documentElement.lang = lang === 'de' ? 'de' : 'en';
            localStorage.setItem('vr_lang', lang);
            const btn = document.getElementById('lang-toggle');
            if (btn) btn.textContent = lang.toUpperCase();

            Object.keys(dict).forEach(key => {
                const el = document.querySelector(`[data-i18n="${key}"]`);
                if (el) el.textContent = dict[key];
            });
        }

        document.getElementById('lang-toggle').addEventListener('click', () => {
            const current = localStorage.getItem('vr_lang') || 'en';
            const next = current === 'en' ? 'de' : 'en';
            applyLanguage(next);
        });

        // Default: English
        applyLanguage(localStorage.getItem('vr_lang') || 'en');

        /* ---------- GLOBAL STATE ---------- */
        let fullList = [];
        let filteredList = [];
        let currentSymbol = "";
        let currentPrice = 0;
        let chart = null;
        let gaugeChart = null;
        let abortController = new AbortController();
        let currentTimeframe = 'MAX';
        let lastHistoryData = null;
        let showMA20 = true;
        let showMA50 = false;
        let showMA200 = false;
        let currentChartType = 'line';

        /* ---------- WATCHLIST ---------- */

        fetch('/api/stocks')
            .then(r => r.json())
            .then(d => {
                fullList = d;
                filterStocks('ALL');
            })
            .catch(err => console.error("API Load Error:", err));

        function getFavorites() {
            try { return JSON.parse(localStorage.getItem('vr_favorites') || '[]'); }
            catch { return []; }
        }

        function saveFavorites(list) {
            localStorage.setItem('vr_favorites', JSON.stringify(list));
        }

        function toggleFavorite(ev, symbol) {
            ev.stopPropagation();
            let favs = getFavorites();
            if (favs.includes(symbol)) {
                favs = favs.filter(s => s !== symbol);
            } else {
                favs.push(symbol);
            }
            saveFavorites(favs);
            renderStockList();
        }

        async function addSymbolToWatchlist() {
            let sym = prompt('Enter ticker symbol (e.g. GM, AAPL):');
            if (!sym) return;
            sym = sym.trim().toUpperCase();

            if (fullList.some(s => (s.Symbol || s.symbol || '').toUpperCase() === sym)) {
                alert('Symbol is already in the list.');
                return;
            }

            try {
                const r = await fetch(`/api/details/${sym}`);
                const d = await r.json();
                if (d.error) throw new Error(d.error);

                let region = 'US';
                if ((d.country || '').includes('Germany')) region = 'DE';

                const newItem = {
                    Symbol: sym,
                    Name: d.name || sym,
                    Region: region,
                    Price: d.price_now || 0,
                    Reason: 'Manually added'
                };
                fullList.push(newItem);

                let favs = getFavorites();
                if (!favs.includes(sym)) {
                    favs.push(sym);
                    saveFavorites(favs);
                }

                filterStocks('ALL');

                setTimeout(() => {
                    const idx = filteredList.findIndex(s => (s.Symbol || s.symbol) === sym);
                    if (idx >= 0) selectStock(filteredList[idx], idx);
                }, 100);

            } catch (e) {
                alert('Symbol not found.');
            }
        }

        function filterStocks(reg) {
            document.querySelectorAll('.region-btn').forEach(b => {
                b.classList.remove('bg-teal-600', 'text-white', 'shadow-sm');
                b.classList.add('text-slate-400');
                if (b.dataset.reg === reg) {
                    b.classList.add('bg-teal-600', 'text-white', 'shadow-sm');
                    b.classList.remove('text-slate-400');
                }
            });

            if (reg === 'FAV') {
                const favs = getFavorites();
                filteredList = fullList.filter(s => favs.includes(s.Symbol || s.symbol));
            } else if (reg === 'ALL') {
                filteredList = fullList;
            } else {
                filteredList = fullList.filter(s => (s.Region || s.region || "US").toUpperCase() === reg);
            }
            renderStockList();
        }

        function filterStocksByName(query) {
            query = query.toLowerCase();
            const activeRegBtn = document.querySelector('.region-btn.bg-teal-600');
            const activeReg = activeRegBtn ? activeRegBtn.dataset.reg : 'ALL';

            let baseList = fullList;
            if (activeReg === 'FAV') {
                const favs = getFavorites();
                baseList = fullList.filter(s => favs.includes(s.Symbol || s.symbol));
            } else if (activeReg !== 'ALL') {
                baseList = fullList.filter(s => (s.Region || s.region || "US").toUpperCase() === activeReg);
            }

            filteredList = baseList.filter(s =>
                (s.Name && s.Name.toLowerCase().includes(query)) ||
                (s.Symbol && s.Symbol.toLowerCase().includes(query))
            );
            renderStockList();
        }

        function renderStockList() {
            const container = document.getElementById('watchlist-container');
            container.innerHTML = '';
            const favs = getFavorites();

            if (filteredList.length === 0) {
                container.innerHTML = '<div class="p-4 text-xs text-slate-500 text-center">No stocks found.</div>';
                return;
            }

            filteredList.forEach((s, idx) => {
                const symbol = s.Symbol || s.symbol;
                const isFav = favs.includes(symbol);
                const price = parseFloat(s.Price || s.price || 0).toFixed(2);

                const div = document.createElement('div');
                div.className = `wl-item px-5 py-3 cursor-pointer group opacity-80 hover:opacity-100 flex flex-col gap-1`;
                if (symbol === currentSymbol) div.classList.add('active', 'opacity-100');

                div.onclick = () => selectStock(s, idx);

                div.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-2">
                            <button onclick="toggleFavorite(event, '${symbol}')" class="text-slate-600 hover:text-teal-400">
                                <i data-lucide="star" class="w-3 h-3 ${isFav ? 'fill-teal-400 text-teal-400' : ''}"></i>
                            </button>
                            <span class="font-bold text-slate-200 text-sm truncate max-w-[120px]">${s.Name || s.name}</span>
                            <span class="wl-badge group-hover:bg-slate-700 transition">${symbol}</span>
                        </div>
                        <span class="font-bold text-white text-sm">$${price}</span>
                    </div>
                    <div class="flex justify-between items-center text-[10px]">
                        <span class="text-slate-500">${s.Region || 'US'} • ${s.Reason ? s.Reason.substring(0, 15) + '...' : 'Underpriced'}</span>
                        ${(s.peg && s.peg < 1.5) ? '<span class="text-teal-400 flex items-center gap-1">Underpriced</span>' : ''}
                    </div>
                `;
                container.appendChild(div);
            });
            lucide.createIcons();

            if (!currentSymbol && filteredList.length > 0) {
                selectStock(filteredList[0], 0);
            }
        }
        // Beschreibung automatisch formatieren (global)
        function formatCompanyDescription(text, name, symbol) {
            if (!text) return "No description available.";

            let formatted = text;

            // 1) Firmenname am Anfang fett + Ticker in Klammern
            if (name) {
                const safeName = name.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); // Regex-escape
                const nameRegex = new RegExp("^" + safeName);                // nur ganz am Anfang matchen

                if (nameRegex.test(formatted)) {
                    formatted = formatted.replace(
                        nameRegex,
                        `<span class="font-semibold text-slate-100">${name}${symbol ? " (" + symbol + ")" : ""}</span>`
                    );
                }
            }

            // 2) Sub-Überschriften hervorheben
            const subtitles = [
                "The company operates",
                "The company provides",
                "The company offers",
                "Its segments include",
                "Segments:",
                "Products:",
                "Services:",
                "Operations:"
            ];

            subtitles.forEach(keyword => {
                const regex = new RegExp(keyword, "gi");
                formatted = formatted.replace(
                    regex,
                    `<br><br><span class="font-bold text-slate-200">${keyword}</span>`
                );
            });

            // 3) Sätze umbrechen
            formatted = formatted.replace(/\. /g, ".<br>");

            return formatted;
        }


        /* ---------- SELECTION & DETAILS ---------- */

        function selectStock(s, idx) {
            currentSymbol = s.Symbol || s.symbol;

            const items = document.querySelectorAll('.wl-item');
            items.forEach(el => el.classList.remove('active', 'opacity-100'));
            if (items[idx]) items[idx].classList.add('active', 'opacity-100');

            document.getElementById('header-name').innerText = s.Name || s.name;
            document.getElementById('header-ticker').innerText = currentSymbol;
            document.getElementById('header-price').innerText = "$" + parseFloat(s.Price || 0).toFixed(2);
            document.getElementById('yahoo-link').href = `https://finance.yahoo.com/quote/${currentSymbol}`;

            document.getElementById('val-mcap').innerText = "...";
            document.getElementById('val-pe').innerText = "...";
            document.getElementById('val-margin').innerText = "...";
            document.getElementById('company-desc').innerText = "Loading description...";
            document.getElementById('strengths-list').innerHTML = '<li class="text-xs text-slate-500">Loading...</li>';
            document.getElementById('risks-list').innerHTML = '<li class="text-xs text-slate-500">Loading...</li>';

            // Reset Extra-KPIs
            const extraIds = [
                'kpi-beta', 'kpi-de', 'kpi-roe', 'kpi-roic',
                'kpi-ev-ebitda', 'kpi-ev-sales',
                'kpi-current', 'kpi-quick',
                'kpi-fcf', 'kpi-payout'
            ];
            extraIds.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.innerText = '...';
            });

            updateChart(currentTimeframe);
            loadDetails(currentSymbol);
        }

        async function loadDetails(sym) {
            try {
                const r = await fetch(`/api/details/${sym}`);
                const d = await r.json();
                if (d.error) return;

                if (d.price_now) {
                    currentPrice = d.price_now;
                    document.getElementById('header-price').innerText = "$" + Number(d.price_now).toFixed(2);
                }

                document.getElementById('header-sector').innerText = d.sector || '-';
                document.getElementById('header-industry').innerText = d.industry || '-';

                // Company description
                document.getElementById('company-desc').innerHTML =
                    formatCompanyDescription(d.description, d.name, d.symbol);



                // Market Cap
                document.getElementById('val-mcap').innerText = formatNumber(d.market_cap);

                // PE / PEG
                if (d.pe) {
                    document.getElementById('val-pe').innerText = d.pe.toFixed(2);
                    let pegText = d.peg ? `PEG: ${d.peg.toFixed(2)}` : 'PEG: N/A';
                    document.getElementById('sub-pe').innerText = pegText;

                    const badge = document.getElementById('badge-pe-rating');
                    let peValBandWidth = 0;

                    if (d.pe < 15) {
                        badge.innerText = "Cheap";
                        badge.className = "text-[9px] text-teal-300 bg-teal-500/20 px-2 py-0.5 rounded";
                        peValBandWidth = 30;
                    } else if (d.pe > 25) {
                        badge.innerText = "Exp.";
                        badge.className = "text-[9px] text-red-300 bg-red-500/20 px-2 py-0.5 rounded";
                        peValBandWidth = 90;
                    } else {
                        badge.innerText = "Fair";
                        badge.className = "text-[9px] text-slate-400 bg-slate-800 px-2 py-0.5 rounded";
                        peValBandWidth = 60;
                    }
                    document.getElementById('pe-range-fill').style.width = peValBandWidth + "%";
                } else {
                    document.getElementById('pe-range-fill').style.width = "0%";
                }

                // Margin
                if (d.profit_margin) {
                    const margin = (d.profit_margin * 100).toFixed(1);
                    document.getElementById('val-margin').innerText = margin + "%";
                    let barW = Math.min((d.profit_margin * 100) * 3, 100);
                    document.getElementById('prog-margin').style.width = barW + "%";
                } else {
                    document.getElementById('prog-margin').style.width = "0%";
                }

                // Growth
                if (d.revenue_growth != null) {
                    const growth = (d.revenue_growth * 100).toFixed(1);
                    const el = document.getElementById('val-growth');
                    el.innerText = (growth > 0 ? "+" : "") + growth + "%";
                    el.className = growth > 0 ? "text-2xl font-bold text-white tracking-tight" : "text-2xl font-bold text-red-400 tracking-tight";

                    const badge = document.getElementById('val-growth-badge');
                    badge.innerText = growth > 0 ? "Growing" : "Declining";
                    badge.className = growth > 0 ? "text-[9px] text-green-400 font-bold" : "text-[9px] text-red-400 font-bold";

                    const growthBar = document.getElementById('growth-bar');
                    let gw = Math.min(Math.abs(d.revenue_growth * 100) * 2, 100);
                    growthBar.style.width = gw + "%";
                } else {
                    document.getElementById('val-growth').innerText = "--";
                    document.getElementById('growth-bar').style.width = "0%";
                }

                // --- Extra KPIs unten ---
                const fmt = (v, ddec = 2) => (v != null ? v.toFixed(ddec) : "N/A");

                document.getElementById('kpi-beta').innerText =
                    d.beta != null ? d.beta.toFixed(2) : "N/A";

                document.getElementById('kpi-de').innerText =
                    d.debt_to_equity != null ? d.debt_to_equity.toFixed(1) : "N/A";

                document.getElementById('kpi-roe').innerText =
                    d.roe != null ? (d.roe * 100).toFixed(1) + "%" : "N/A";

                document.getElementById('kpi-roic').innerText =
                    d.roic != null ? (d.roic * 100).toFixed(1) + "%" : "N/A";

                document.getElementById('kpi-ev-ebitda').innerText =
                    d.ev_to_ebitda != null ? d.ev_to_ebitda.toFixed(1) : "N/A";

                document.getElementById('kpi-ev-sales').innerText =
                    d.ev_to_sales != null ? d.ev_to_sales.toFixed(1) : "N/A";

                document.getElementById('kpi-current').innerText =
                    d.current_ratio != null ? d.current_ratio.toFixed(2) : "N/A";

                document.getElementById('kpi-quick').innerText =
                    d.quick_ratio != null ? d.quick_ratio.toFixed(2) : "N/A";

                document.getElementById('kpi-fcf').innerText =
                    d.free_cash_flow != null ? "$" + formatNumber(d.free_cash_flow) : "N/A";

                document.getElementById('kpi-payout').innerText =
                    d.payout_ratio != null ? (d.payout_ratio * 100).toFixed(1) + "%" : "N/A";


                // Lists & News
                updateList('strengths-list', d.pros);
                updateList('risks-list', d.risks);
                renderNews(d.news);


                // VR Score (simple heuristic)
                let score = 50;
                if (d.pe && d.pe < 20) score += 10;
                if (d.peg && d.peg < 1.5) score += 10;
                if (d.revenue_growth > 0) score += 10;
                if (d.profit_margin > 0.1) score += 10;
                if (d.perf_1y > 0) score += 10;

                document.getElementById('header-score').innerText = score;
                renderGauge(score);
                const scoreText = document.getElementById('header-score-text');
                const sentimentText = document.getElementById('sentiment-text');

                let rating = "Hold";
                if (score > 75) rating = "Strong Buy";
                else if (score > 60) rating = "Buy";
                else if (score < 40) rating = "Sell";

                scoreText.innerText = rating;
                sentimentText.innerText = rating;

            } catch (e) { console.error(e); }
        }

        /* ---------- CHART ---------- */
        /* ---------- CHARTING ---------- */

        function updateTimeframe(tf) {
            // Wrapper für die Buttons – ruft einfach die eigentliche Chart-Logik auf
            updateChart(tf);
        }

        async function updateChart(tf) {
            currentTimeframe = tf;
            document.querySelectorAll('.tf-btn').forEach(b => {
                if (b.dataset.tf === tf) b.classList.add('active');
                else b.classList.remove('active');
            });

            if (abortController) abortController.abort();
            abortController = new AbortController();

            try {
                const r = await fetch(`/api/history/${currentSymbol}/${tf}`, { signal: abortController.signal });
                const json = await r.json();

                if (!json.error && json.candle && json.candle.length > 0) {
                    lastHistoryData = json;
                    renderApexChart(json);
                    updatePerfLabel(tf, json.candle);
                }
            } catch (e) {
                if (e.name !== 'AbortError') console.warn(e);
            }
        }

        function renderApexChart(d) {
            if (!d || !d.candle) return;

            let series = [];

            if (currentChartType === 'candles') {
                const candleData = d.candle.map(x => ({ x: x[0], y: [x[1], x[2], x[3], x[4]] }));
                series.push({
                    name: 'Price',
                    type: 'candlestick',
                    data: candleData,
                    color: '#22c55e'
                });
            } else {
                const lineData = d.candle.map(x => ({ x: x[0], y: x[4] }));
                series.push({
                    name: 'Price',
                    type: 'area',
                    data: lineData,
                    color: '#22d3ee'
                });
            }

            if (showMA20 && d.ma20) series.push({
                name: 'MA 20',
                type: 'line',
                data: d.ma20,
                color: '#facc15'
            });
            if (showMA50 && d.ma50) series.push({
                name: 'MA 50',
                type: 'line',
                data: d.ma50,
                color: '#fb7185'
            });
            if (showMA200 && d.ma200) series.push({
                name: 'MA 200',
                type: 'line',
                data: d.ma200,
                color: '#60a5fa'
            });

            const isLine = currentChartType === 'line';

            const options = {
                chart: {
                    height: '100%',
                    type: isLine ? 'area' : 'candlestick',
                    fontFamily: 'Inter, sans-serif',
                    toolbar: { show: false },
                    animations: { enabled: false },
                    background: 'transparent'
                },
                theme: { mode: 'dark' },
                stroke: {
                    curve: 'straight',
                    width: isLine ? 2 : 1,
                },
                fill: {
                    type: isLine ? 'gradient' : 'solid',
                    gradient: {
                        shadeIntensity: 1,
                        opacityFrom: 0.4,
                        opacityTo: 0.05,
                        stops: [0, 100]
                    }
                },
                series: series,
                xaxis: {
                    type: 'datetime',
                    tooltip: { enabled: false },
                    axisBorder: { show: false },
                    axisTicks: { show: false },
                    labels: {
                        style: { colors: '#64748b', fontSize: '10px' },
                        offsetY: 10
                    }
                },
                yaxis: {
                    opposite: false,
                    labels: {
                        formatter: (v) => v.toFixed(1),
                        style: { colors: '#64748b', fontSize: '10px' }
                    }
                },
                grid: {
                    borderColor: 'rgba(255,255,255,0.05)',
                    strokeDashArray: 4,
                    padding: {
                        top: 10,
                        bottom: 60,
                        left: 8,
                        right: 4
                    }
                },


                plotOptions: {
                    candlestick: {
                        colors: { upward: '#22c55e', downward: '#ef4444' }
                    }
                },
                dataLabels: { enabled: false },
                legend: { show: false }
            };

            if (chart) chart.destroy();
            chart = new ApexCharts(document.querySelector("#chart"), options);
            chart.render();
        }

        function renderGauge(score) {
            const options = {
                series: [score],
                chart: { height: 180, type: 'radialBar', fontFamily: 'Inter' },
                plotOptions: {
                    radialBar: {
                        startAngle: -135, endAngle: 135,
                        hollow: { size: '60%', background: 'transparent' },
                        track: { background: 'rgba(255,255,255,0.05)', strokeWidth: '100%' },
                        dataLabels: {
                            show: true,
                            name: { show: false },
                            value: {
                                offsetY: 10,
                                fontSize: '24px',
                                fontWeight: '700',
                                color: '#fff',
                                formatter: (v) => v
                            }
                        }
                    }
                },
                fill: {
                    type: 'gradient',
                    gradient: {
                        shade: 'dark',
                        type: 'horizontal',
                        gradientToColors: ['#2dd4bf'],
                        stops: [0, 100]
                    }
                },
                stroke: { lineCap: 'round' },
                colors: ['#14b8a6']
            };

            if (gaugeChart) gaugeChart.destroy();
            gaugeChart = new ApexCharts(document.querySelector("#gauge-chart"), options);
            gaugeChart.render();
        }

        /* ---------- HELPERS ---------- */

        function updatePerfLabel(tf, candles) {
            if (!candles || candles.length < 2) return;
            const start = candles[0][4];
            const end = candles[candles.length - 1][4];
            const perf = ((end / start) - 1) * 100;
            const el = document.getElementById('tf-perf');

            el.innerText = (perf > 0 ? "+" : "") + perf.toFixed(2) + "% (" + tf + ")";
            if (perf >= 0) el.className = "text-xs text-teal-400 font-bold bg-teal-500/10 px-2 py-0.5 rounded";
            else el.className = "text-xs text-red-400 font-bold bg-red-500/10 px-2 py-0.5 rounded";
        }

        function updateList(id, items) {
            const list = document.getElementById(id);
            if (!items || items.length === 0) {
                list.innerHTML = '<li class="text-xs text-slate-500">No data available.</li>';
                return;
            }
            list.innerHTML = items.map(item => `
                <li class="flex items-start gap-2 text-xs text-slate-300">
                    <span class="text-teal-400 font-bold mt-0.5">•</span>
                    ${item}
                </li>
            `).join('');
        }

        function renderNews(news) {
            const container = document.getElementById('news-container');
            if (!news || news.length === 0) {
                container.innerHTML = '<div class="text-slate-500 text-xs">No recent news.</div>';
                return;
            }
            container.innerHTML = news.map(n => `
                <a href="${n.link}" target="_blank" class="block bg-slate-800/30 p-3 rounded border border-white/5 hover:border-teal-500/30 hover:bg-slate-800/50 transition group">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-[10px] text-teal-500 font-bold bg-teal-500/10 px-1.5 py-0.5 rounded">${n.publisher}</span>
                        <span class="text-[10px] text-slate-600">${n.date}</span>
                    </div>
                    <h4 class="text-xs font-medium text-slate-300 group-hover:text-white leading-relaxed line-clamp-2">${n.title}</h4>
                </a>
            `).join('');
        }

        function formatNumber(num) {
            if (num == null) return 'N/A';
            if (num >= 1e12) return (num / 1e12).toFixed(1) + 'T';
            if (num >= 1e9) return (num / 1e9).toFixed(1) + 'B';
            if (num >= 1e6) return (num / 1e6).toFixed(1) + 'M';
            return num.toLocaleString();
        }

        function toggleMA(val) {
            if (val === '20') showMA20 = !showMA20;
            if (val === '50') showMA50 = !showMA50;
            if (val === '200') showMA200 = !showMA200;

            const btn = document.querySelector(`.ma-btn[data-ma="${val}"]`);
            if (btn) btn.classList.toggle('active');

            if (lastHistoryData) renderApexChart(lastHistoryData);
        }

        function setChartType(type) {
            currentChartType = type;
            document.querySelectorAll('.charttype-btn').forEach(b => {
                if (b.dataset.ctype === type) b.classList.add('active');
                else b.classList.remove('active');
            });
            if (lastHistoryData) renderApexChart(lastHistoryData);
        }

        function toggleTheme() {
            document.documentElement.classList.toggle('dark');
        }
    </script>
</body>

</html>