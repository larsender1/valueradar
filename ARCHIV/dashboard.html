<!DOCTYPE html>
<html lang="de" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ValueRadar Pro Terminal</title>
    <meta name="description"
        content="ValueRadar Pro Terminal ‚Äì interaktives Dashboard f√ºr Fundamentalanalyse, Kennzahlen, Charts und Watchlists.">
    <meta name="robots" content="noindex, nofollow">

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: {
                            bg: '#020617',
                            card: '#020617'
                        }
                    },
                    boxShadow: {
                        'glow': '0 0 40px rgba(16,185,129,0.25)'
                    }
                }
            }
        }
    </script>

    <!-- ApexCharts -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body {
            background-color: #020617;
            min-height: 100vh;
            color: #cbd5e1;
        }

        body.light h1,
        body.light h2,
        body.light h3,
        body.light .text-slate-100 {
            color: #0f172a !important;
        }

        .bg-dark-gradient {
            background: radial-gradient(circle at top left, rgba(16, 185, 129, 0.10) 0, transparent 55%),
                radial-gradient(circle at bottom right, rgba(59, 130, 246, 0.10) 0, transparent 55%);
        }

        .bg-dark-card {
            background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.95) 0, rgba(15, 23, 42, 0.98) 40%, #020617 100%);
        }

        .border-dark-border {
            border-color: rgba(30, 64, 175, 0.3);
        }

        .scroll-thin::-webkit-scrollbar {
            width: 6px;
        }

        .scroll-thin::-webkit-scrollbar-track {
            background: transparent;
        }

        .scroll-thin::-webkit-scrollbar-thumb {
            background: rgba(30, 64, 175, 0.6);
            border-radius: 9999px;
        }

        .region-btn.active-region {
            background-color: #10b981;
            color: white !important;
            box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.3);
        }

        .tf-btn {
            transition: all 0.15s ease-in-out;
        }

        .active-tf {
            background-color: #10b981;
            color: white !important;
            box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.3);
        }

        .watch-row-active {
            background-color: #0f172a !important;
            border-color: #10b981 !important;
        }

        body.light {
            background-color: #f9fafb;
            color: #0f172a;
        }

        body.light .bg-dark-card {
            background-color: #ffffff;
        }

        body.light .border-dark-border {
            border-color: #e5e7eb;
        }

        .apexcharts-tooltip {
            background: #1e293b !important;
            border-color: #334155 !important;
            color: #fff;
        }

        .apexcharts-tooltip-title {
            background: #0f172a !important;
            border-bottom-color: #1e293b !important;
        }

        .glass {
            background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.98) 0, rgba(15, 23, 42, 1) 45%, rgba(15, 23, 42, 1) 100%);
            border: 1px solid rgba(148, 163, 184, 0.2);
            backdrop-filter: blur(18px);
        }

        .ticker-dot {
            width: 6px;
            height: 6px;
            border-radius: 999px;
            background: radial-gradient(circle, #22c55e 0, #16a34a 40%, #166534 100%);
            box-shadow: 0 0 10px rgba(34, 197, 94, 0.9);
        }

        .scrollbar-none::-webkit-scrollbar {
            display: none;
        }

        .scrollbar-none {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>

<body class="text-slate-100">
    <header class="border-b border-slate-800/60 bg-slate-950/80 backdrop-blur-lg sticky top-0 z-40">
        <div
            class="max-w-[1600px] mx-auto px-4 sm:px-6 lg:px-8 py-3 flex flex-wrap items-center justify-between gap-3 md:gap-6">
            <div class="flex items-center gap-6 min-w-0">
                <!-- Back Button -->
                <button onclick="window.location.href='/'"
                    class="hidden sm:inline-flex items-center gap-1 text-xs font-medium text-slate-400 hover:text-emerald-400 px-2 py-1 rounded-lg border border-slate-700 hover:border-emerald-500 bg-slate-950/60 transition">
                    <i data-lucide="arrow-left" class="w-3 h-3"></i>
                    <span data-i18n="header.back">Zur√ºck</span>
                </button>

                <a href="#"
                    class="flex items-center gap-2 bg-slate-900/70 border border-slate-700/70 rounded-xl px-2.5 py-1 shadow-lg shadow-emerald-500/5">
                    <!-- Mobile Logo: VR PRO kompakt -->
                    <div class="sm:hidden flex items-center justify-center">
                        <div
                            class="flex items-center bg-emerald-500/20 border border-emerald-500/30 rounded-xl px-3 py-1 gap-2">
                            <div
                                class="w-6 h-6 flex items-center justify-center bg-emerald-500 text-white font-bold text-xs rounded">
                                VR
                            </div>
                            <span class="text-[10px] font-bold text-emerald-400 tracking-widest">PRO</span>
                        </div>
                    </div>

                    <!-- Ab SM: ValueRadar + PRO TERMINAL -->
                    <div class="hidden sm:flex items-center gap-2">
                        <div
                            class="bg-emerald-500 text-white font-bold text-xs p-1 rounded group-hover:bg-emerald-400 transition">
                            VR
                        </div>
                        <div class="flex flex-col leading-none">
                            <span class="text-lg font-bold text-white tracking-tight">ValueRadar</span>
                            <span class="text-[10px] text-emerald-500 font-bold tracking-wider">PRO TERMINAL</span>
                        </div>
                    </div>
                </a>

                <!-- Desktop Global Search -->
                <div
                    class="hidden md:flex items-center bg-slate-900/80 border border-slate-800 rounded-xl px-3 py-1.5 text-sm text-slate-400 shadow-inner shadow-slate-900 focus-within:ring-1 focus-within:ring-emerald-500 transition-all">
                    <i data-lucide="search" class="w-4 h-4 text-slate-500 mr-2"></i>
                    <input type="text" id="global-search" placeholder="Suche Aktie..."
                        class="bg-transparent border-none outline-none text-sm w-full text-white placeholder-slate-600"
                        onkeyup="filterDropdown(this.value)">
                    <span class="text-xs text-slate-600 border border-slate-700 rounded px-1.5 py-0.5 ml-2">‚åòK</span>
                </div>
            </div>

            <!-- Kompakter Top-Bar Block -->
            <div
                class="flex flex-nowrap items-center gap-2 md:gap-4 justify-between w-full md:w-auto mt-2 md:mt-0 overflow-x-auto scrollbar-none">

                <!-- Region / Watchlist Filter -->
                <div class="flex bg-slate-900 rounded-lg p-1 border border-slate-800">
                    <button onclick="filterStocks('ALL')"
                        class="region-btn text-xs px-3 py-1 rounded-lg text-slate-400 hover:bg-slate-800 border border-transparent"
                        data-reg="ALL" data-i18n="region.all">Alle</button>
                    <button onclick="filterStocks('US')"
                        class="region-btn text-xs px-3 py-1 rounded-lg text-slate-400 hover:bg-slate-800 border border-transparent"
                        data-reg="US" data-i18n="region.us">US</button>
                    <button onclick="filterStocks('DE')"
                        class="region-btn text-xs px-3 py-1 rounded-lg text-slate-400 hover:bg-slate-800 border border-transparent"
                        data-reg="DE" data-i18n="region.de">DE</button>
                    <button onclick="filterStocks('FAV')"
                        class="region-btn text-xs px-3 py-1 rounded-lg text-slate-400 hover:bg-slate-800 border border-transparent"
                        data-reg="FAV" data-i18n="region.fav">Watchlist</button>
                </div>

                <!-- Tabs Dashboard / Glossary (nur ab md) -->
                <div class="hidden md:flex items-center bg-slate-900 rounded-lg p-1 border border-slate-800">
                    <button onclick="switchView('dashboard')" id="tab-dashboard"
                        class="px-3 py-1 text-xs font-semibold rounded-md text-emerald-400 bg-slate-800 shadow-inner"
                        data-i18n="tab.dashboard">
                        Dashboard
                    </button>
                    <button onclick="switchView('glossary')" id="tab-glossary"
                        class="px-3 py-1 text-xs font-semibold rounded-md text-slate-400 hover:bg-slate-800"
                        data-i18n="tab.glossary">
                        Erkl√§rungen
                    </button>
                </div>

                <!-- Language Switch mit Flaggen -->
                <div class="flex bg-slate-900 rounded-lg p-1 border border-slate-800">
                    <button id="btn-lang-de" onclick="setLang('de')"
                        class="px-2 py-1 text-xs font-semibold rounded-md text-emerald-400 bg-slate-800"
                        aria-label="Deutsch">
                        üá©üá™
                    </button>
                    <button id="btn-lang-en" onclick="setLang('en')"
                        class="px-2 py-1 text-xs font-semibold rounded-md text-slate-400 hover:bg-slate-800"
                        aria-label="English">
                        üá∫üá∏
                    </button>
                </div>

                <!-- Live Badge -->
                <div class="h-6 w-px bg-slate-800"></div>

                <div class="hidden sm:flex items-center gap-1">
                    <span
                        class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full border border-emerald-500/40 bg-emerald-500/10 text-[11px] font-medium text-emerald-300 shadow-sm shadow-emerald-500/30">
                        <span class="w-1.5 h-1.5 rounded-full bg-emerald-400 animate-pulse"></span>
                        <span data-i18n="header.live">Live</span>
                    </span>
                    <span class="text-xs text-slate-400" data-i18n="header.scan">Scan: Global Undervalued
                        Watchlist</span>
                </div>

                <!-- Theme Toggle -->
                <button onclick="toggleTheme()"
                    class="relative flex items-center justify-center w-9 h-9 rounded-full bg-slate-900 border border-slate-700 text-slate-400 hover:border-emerald-500 hover:text-emerald-400 transition-all shadow-inner shadow-slate-950">
                    <i id="theme-icon" data-lucide="moon" class="w-4 h-4"></i>
                </button>

                <!-- Account -->
                <div class="flex items-center gap-2 pl-3 border-l border-slate-800">
                    <div class="hidden sm:flex flex-col text-right">
                        <span class="text-xs text-slate-500" data-i18n="header.account">Account</span>
                        <span id="account-name"
                            class="text-sm font-semibold text-slate-100 truncate max-w-[140px]">demo@valueradar.ai</span>
                    </div>
                    <div
                        class="w-8 h-8 rounded-full bg-gradient-to-tr from-emerald-500 to-sky-500 flex items-center justify-center text-xs font-bold">
                        VR
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-[1600px] mx-auto px-4 sm:px-6 lg:px-8 py-6 lg:py-8 space-y-6">
        <!-- DASHBOARD VIEW -->
        <section id="view-dashboard" class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <!-- Watchlist -->
            <aside class="lg:col-span-1 overflow-hidden rounded-2xl glass shadow-glow flex flex-col max-h-[650px]">
                <div class="px-4 py-3 border-b border-slate-800/80 flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <span class="ticker-dot"></span>
                        <div>
                            <div class="text-[11px] text-slate-500 uppercase tracking-[0.2em] font-bold"
                                data-i18n="watchlist.title">Watchlist</div>
                            <div class="text-xs text-slate-400" data-i18n="watchlist.subtitle">Global Undervalued Stocks
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <span
                            class="text-[10px] text-slate-500 uppercase tracking-wide bg-slate-900 px-2 py-0.5 rounded-full border border-slate-800">CSV
                            Sync</span>
                        <button onclick="addSymbolToWatchlist()"
                            class="w-7 h-7 rounded-lg bg-slate-900 border border-slate-700 flex items-center justify-center text-slate-400 hover:text-emerald-400 hover:border-emerald-500 transition"
                            title="Symbol hinzuf√ºgen">
                            <i data-lucide="plus" class="w-3 h-3"></i>
                        </button>
                    </div>
                </div>

                <div class="px-3 pt-3 pb-2 border-b border-slate-800/80 bg-slate-950/60">
                    <div
                        class="flex items-center bg-slate-900/90 border border-slate-800 rounded-xl px-2 py-1.5 text-xs text-slate-400 shadow-inner shadow-slate-950">
                        <i data-lucide="list-filter" class="w-3.5 h-3.5 text-slate-500 mr-2"></i>
                        <input type="text" id="watchlist-search" placeholder="Filtere nach Name oder Ticker..."
                            class="bg-transparent border-none outline-none text-xs w-full text-slate-100 placeholder-slate-600"
                            onkeyup="filterStocksByName(this.value)">
                    </div>
                </div>

                <div id="watchlist-container"
                    class="flex-1 overflow-y-auto scroll-thin divide-y divide-slate-800/70 bg-slate-950/60"></div>

                <div
                    class="px-3 py-2 border-t border-slate-800/80 bg-slate-950/80 flex items-center justify-between text-[11px] text-slate-500">
                    <span id="watchlist-count">0 Aktien</span>
                    <span class="flex items-center gap-1">
                        <i data-lucide="cpu" class="w-3.5 h-3.5"></i>
                        <span>Powered by Python Scan</span>
                    </span>
                </div>
            </aside>

            <!-- Main Content -->
            <section class="lg:col-span-3 flex flex-col gap-6">
                <!-- Header Stock Info -->
                <div class="flex flex-col md:flex-row justify-between items-end gap-4">
                    <div>
                        <div class="flex items-center gap-3 mb-1">
                            <h1 id="header-name" class="text-3xl font-bold tracking-tight text-slate-100">Lade Daten...
                            </h1>
                            <span id="badge-ticker"
                                class="bg-slate-900/80 text-xs px-2 py-0.5 rounded border border-slate-700 font-mono">---</span>
                            <span id="badge-region"
                                class="bg-slate-900/80 text-xs px-2 py-0.5 rounded border border-slate-700 font-bold">--</span>
                        </div>
                        <div class="text-sm text-slate-500 flex gap-4">
                            <span id="header-industry">Technology</span> ‚Ä¢
                            <span id="header-sector">Consumer Electronics</span>
                            <a id="yahoo-link" href="#" target="_blank"
                                class="text-xs text-blue-500 hover:underline flex items-center gap-1">Yahoo Finance
                                ‚Üó</a>
                        </div>
                    </div>
                    <div class="text-right">
                        <div id="header-price" class="text-4xl font-bold tracking-tight text-slate-100">--</div>
                        <div class="text-emerald-400 text-sm font-medium flex items-center justify-end gap-1">
                            <i data-lucide="trending-up" class="w-4 h-4"></i>
                            <span data-i18n="header.liveprice">Live Price</span>
                        </div>
                    </div>
                </div>

                <!-- KPIs -->
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                    <div
                        class="bg-dark-card border border-dark-border rounded-xl p-4 relative overflow-hidden group hover:border-slate-600 transition">
                        <div
                            class="absolute top-0 right-0 p-3 opacity-10 group-hover:opacity-20 transition text-emerald-500">
                            <i data-lucide="bar-chart-2" class="w-8 h-8"></i>
                        </div>
                        <div class="text-xs text-slate-500 uppercase font-bold tracking-wider mb-1" data-i18n="kpi.pe">
                            KGV (PE)</div>
                        <div id="kpi-pe" class="text-xl font-bold text-white">--</div>
                    </div>
                    <div
                        class="bg-dark-card border border-dark-border rounded-xl p-4 hover:border-slate-600 transition">
                        <div class="text-xs text-slate-500 uppercase font-bold tracking-wider mb-1" data-i18n="kpi.peg">
                            PEG Ratio</div>
                        <div id="kpi-peg" class="text-xl font-bold text-white">--</div>
                    </div>
                    <div class="bg-dark-card border border-dark-border rounded-xl p-4 opacity-70">
                        <div class="text-xs text-slate-500 uppercase font-bold tracking-wider mb-1"
                            data-i18n="kpi.mcap">Market Cap</div>
                        <div id="kpi-mcap" class="text-xl font-bold text-white">N/A</div>
                    </div>
                    <div class="bg-dark-card border border-dark-border rounded-xl p-4 opacity-70">
                        <div class="text-xs text-slate-500 uppercase font-bold tracking-wider mb-1"
                            data-i18n="kpi.margin">Margins</div>
                        <div id="kpi-margin" class="text-xl font-bold text-white">N/A</div>
                    </div>
                    <div class="bg-dark-card border border-dark-border rounded-xl p-4">
                        <div class="text-xs text-slate-500 uppercase font-bold tracking-wider mb-1"
                            data-i18n="kpi.analyst">Analyst Rating</div>
                        <div class="text-xl font-bold text-emerald-400">BUY</div>
                    </div>
                    <div class="bg-dark-card border border-dark-border rounded-xl p-4 relative overflow-hidden">
                        <div class="absolute inset-0 bg-gradient-to-r from-emerald-500/10 to-transparent"></div>
                        <div class="text-xs text-slate-500 uppercase font-bold tracking-wider mb-1 relative z-10"
                            data-i18n="kpi.vrscore">VR Score</div>
                        <div class="text-xl font-bold text-emerald-400 relative z-10">92</div>
                    </div>
                </div>

                <!-- CHART + FINANCIALS -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- PRICE ACTION / CHART CARD -->
                    <div
                        class="lg:col-span-2 bg-dark-card border border-dark-border rounded-2xl p-1 flex flex-col shadow-xl min-h-[500px] relative">
                        <!-- Desktop: Timeframes + MAs oben rechts (ab md) -->
                        <div class="absolute top-4 right-4 z-10 hidden md:flex gap-2">
                            <div class="flex bg-slate-900 rounded-lg p-1 border border-slate-800">
                                <button onclick="updateTimeframe('1W')"
                                    class="tf-btn px-3 py-1 text-xs font-bold rounded hover:bg-slate-800 text-slate-400 transition">1W</button>
                                <button onclick="updateTimeframe('1M')"
                                    class="tf-btn px-3 py-1 text-xs font-bold rounded hover:bg-slate-800 text-slate-400 transition">1M</button>
                                <button onclick="updateTimeframe('6M')"
                                    class="tf-btn px-3 py-1 text-xs font-bold rounded hover:bg-slate-800 text-slate-400 transition">6M</button>
                                <button onclick="updateTimeframe('1Y')"
                                    class="tf-btn px-3 py-1 text-xs font-bold rounded bg-slate-800 text-slate-100 transition">1Y</button>
                                <button onclick="updateTimeframe('MAX')"
                                    class="tf-btn px-3 py-1 text-xs font-bold rounded hover:bg-slate-800 text-slate-400 transition">MAX</button>
                            </div>
                            <div class="flex bg-slate-900 rounded-lg p-1 border border-slate-800">
                                <button onclick="toggleMA('20')" data-ma="20"
                                    class="ma-btn px-3 py-1 text-xs font-bold rounded active-tf">MA 20</button>
                                <button onclick="toggleMA('50')" data-ma="50"
                                    class="ma-btn px-3 py-1 text-xs font-bold rounded text-slate-400 hover:bg-slate-800">MA
                                    50</button>
                                <button onclick="toggleMA('200')" data-ma="200"
                                    class="ma-btn px-3 py-1 text-xs font-bold rounded text-slate-400 hover:bg-slate-800">MA
                                    200</button>
                            </div>
                        </div>

                        <!-- Titel links oben -->
                        <div class="absolute top-4 left-4 z-10">
                            <h3 class="text-lg font-bold text-white flex items-center gap-2">
                                <i data-lucide="activity" class="text-emerald-500 w-5 h-5"></i>
                                <span data-i18n="chart.title">Price Action</span>
                            </h3>
                        </div>

                        <!-- Mobile: Timeframes + MAs unter dem Titel -->
                        <div class="mt-16 px-3 md:hidden flex flex-col gap-2 z-10">
                            <div
                                class="flex bg-slate-900 rounded-lg p-1 border border-slate-800 w-full justify-between">
                                <button onclick="updateTimeframe('1W')"
                                    class="tf-btn px-3 py-1 text-xs font-bold rounded hover:bg-slate-800 text-slate-400 transition">1W</button>
                                <button onclick="updateTimeframe('1M')"
                                    class="tf-btn px-3 py-1 text-xs font-bold rounded hover:bg-slate-800 text-slate-400 transition">1M</button>
                                <button onclick="updateTimeframe('6M')"
                                    class="tf-btn px-3 py-1 text-xs font-bold rounded hover:bg-slate-800 text-slate-400 transition">6M</button>
                                <button onclick="updateTimeframe('1Y')"
                                    class="tf-btn px-3 py-1 text-xs font-bold rounded bg-slate-800 text-slate-100 transition">1Y</button>
                                <button onclick="updateTimeframe('MAX')"
                                    class="tf-btn px-3 py-1 text-xs font-bold rounded hover:bg-slate-800 text-slate-400 transition">MAX</button>
                            </div>
                            <div
                                class="flex bg-slate-900 rounded-lg p-1 border border-slate-800 w-full justify-between">
                                <button onclick="toggleMA('20')" data-ma="20"
                                    class="ma-btn px-3 py-1 text-xs font-bold rounded active-tf">MA 20</button>
                                <button onclick="toggleMA('50')" data-ma="50"
                                    class="ma-btn px-3 py-1 text-xs font-bold rounded text-slate-400 hover:bg-slate-800">MA
                                    50</button>
                                <button onclick="toggleMA('200')" data-ma="200"
                                    class="ma-btn px-3 py-1 text-xs font-bold rounded text-slate-400 hover:bg-slate-800">MA
                                    200</button>
                            </div>
                        </div>

                        <!-- Chart -->
                        <div id="chart" class="w-full h-full pt-28 md:pt-12"></div>
                    </div>

                    <!-- FINANCIALS CARD -->
                    <div class="bg-dark-card border border-dark-border rounded-2xl p-4 flex flex-col min-h-[400px]">
                        <div class="flex items-center justify-between mb-3">
                            <h3
                                class="text-xs font-bold uppercase tracking-[0.25em] text-slate-500 flex items-center gap-2">
                                <i data-lucide="bar-chart-3" class="w-4 h-4 text-emerald-400"></i>
                                <span data-i18n="fin.title">Financials (Est.)</span>
                            </h3>
                            <span
                                class="text-[10px] text-slate-500 bg-slate-900 border border-slate-800 px-2 py-0.5 rounded-full">2020‚Äì2024E</span>
                        </div>
                        <div id="fin-chart" class="w-full flex-1 min-h-[200px]"></div>

                        <div class="grid grid-cols-2 gap-4 mt-4 pt-4 border-t border-slate-800">
                            <div>
                                <div class="text-[10px] text-slate-500 font-bold uppercase" data-i18n="fin.revgrowth">
                                    Revenue Growth</div>
                                <div id="kpi-revgrowth" class="text-lg font-bold text-emerald-400">+12%</div>
                            </div>
                            <div>
                                <div class="text-[10px] text-slate-500 font-bold uppercase" data-i18n="fin.netmargin">
                                    Net Margin</div>
                                <div id="kpi-netmargin" class="text-lg font-bold text-white">18.5%</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SENTIMENT + NEWS -->
                <div class="grid grid-cols-1 md:grid-cols-12 gap-6">
                    <div
                        class="md:col-span-4 bg-dark-card border border-dark-border rounded-2xl p-5 flex flex-col items-center justify-center relative shadow-lg min-h-[300px]">
                        <div class="absolute inset-x-0 top-0 h-14 bg-gradient-to-b from-emerald-500/10 to-transparent">
                        </div>
                        <div class="relative flex flex-col items-center gap-4 w-full">
                            <h3
                                class="text-sm font-bold text-slate-400 uppercase tracking-[0.25em] flex items-center gap-2">
                                <i data-lucide="gauge" class="w-4 h-4 text-emerald-400"></i>
                                <span data-i18n="sentiment.title">Sentiment</span>
                            </h3>
                            <div id="gauge-chart" class="w-full h-40"></div>
                            <div class="relative text-center space-y-1">
                                <div class="text-xs text-emerald-400 font-semibold tracking-wide"
                                    data-i18n="sentiment.label">Strong Buy</div>
                                <div class="text-[11px] text-slate-500" data-i18n="sentiment.subtitle">Based on
                                    technical & valuation factors</div>
                            </div>
                            <div class="w-full pt-4 border-t border-slate-800">
                                <div class="text-xs text-slate-500 text-center mb-2" data-i18n="sentiment.keydrivers">
                                    Key Drivers</div>
                                <ul id="mini-pros-list" class="text-xs text-emerald-400 space-y-1 px-4">
                                    <li>‚Ä¢ Lade Analyse...</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div
                        class="md:col-span-8 bg-dark-card border border-dark-border rounded-2xl p-5 flex flex-col shadow-lg min-h-[300px]">
                        <h3
                            class="text-sm font-bold text-slate-400 uppercase tracking-widest mb-4 flex items-center gap-2">
                            <i data-lucide="newspaper" class="w-4 h-4"></i>
                            <span data-i18n="news.title">Aktuelle News</span>
                        </h3>
                        <div id="news-container" class="space-y-3 overflow-y-auto max-h-[250px] pr-2">
                            <span class="text-slate-500 text-sm" data-i18n="news.loading">Lade Nachrichten...</span>
                        </div>
                    </div>
                </div>

                <!-- ST√ÑRKEN & RISIKEN -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-dark-card border border-dark-border rounded-2xl p-5 flex flex-col">
                        <div class="flex items-center gap-2 mb-4">
                            <div
                                class="w-8 h-8 rounded-full bg-emerald-500/10 border border-emerald-500/40 flex items-center justify-center">
                                <i data-lucide="trending-up" class="w-4 h-4 text-emerald-400"></i>
                            </div>
                            <div>
                                <div class="text-xs font-bold uppercase tracking-[0.25em] text-emerald-400"
                                    data-i18n="strengths.title">St√§rken</div>
                                <div class="text-[11px] text-slate-500" data-i18n="strengths.subtitle">Warum die Aktie
                                    interessant ist</div>
                            </div>
                        </div>
                        <ul id="strengths-list" class="space-y-2 text-sm text-slate-100">
                            <li class="text-slate-500 text-sm" data-i18n="strengths.loading">Lade St√§rken...</li>
                        </ul>
                    </div>

                    <div class="bg-dark-card border border-dark-border rounded-2xl p-5 flex flex-col">
                        <div class="flex items-center gap-2 mb-4">
                            <div
                                class="w-8 h-8 rounded-full bg-rose-500/10 border border-rose-500/40 flex items-center justify-center">
                                <i data-lucide="alert-triangle" class="w-4 h-4 text-rose-400"></i>
                            </div>
                            <div>
                                <div class="text-xs font-bold uppercase tracking-[0.25em] text-rose-400"
                                    data-i18n="risks.title">Risiken</div>
                                <div class="text-[11px] text-slate-500" data-i18n="risks.subtitle">Worauf du achten
                                    solltest</div>
                            </div>
                        </div>
                        <ul id="risks-list" class="space-y-2 text-sm text-slate-100">
                            <li class="text-slate-500 text-sm" data-i18n="risks.loading">Lade Risiken...</li>
                        </ul>
                    </div>
                </div>
            </section>
        </section>

        <!-- GLOSSARY VIEW -->
        <section id="view-glossary" class="hidden">
            <div class="bg-dark-card border border-dark-border rounded-2xl p-6 space-y-4">
                <h2 class="text-xl font-bold text-slate-100 mb-2" data-i18n="glossary.heading">Erkl√§rungen der
                    Kennzahlen</h2>
                <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4 text-sm text-slate-200">
                    <div class="bg-slate-950/60 border border-slate-800 rounded-xl p-4">
                        <h3 class="text-xs font-bold uppercase tracking-[0.25em] text-slate-500 mb-1">KGV (PE)</h3>
                        <p data-i18n="glossary.pe">
                            Das Kurs-Gewinn-Verh√§ltnis vergleicht den Aktienkurs mit dem Gewinn pro Aktie.
                            Niedriger ist grunds√§tzlich g√ºnstiger, h√§ngt aber stark vom Sektor ab.
                        </p>
                    </div>
                    <div class="bg-slate-950/60 border border-slate-800 rounded-xl p-4">
                        <h3 class="text-xs font-bold uppercase tracking-[0.25em] text-slate-500 mb-1">PEG Ratio</h3>
                        <p data-i18n="glossary.peg">
                            Bewertet das KGV im Verh√§ltnis zum Gewinnwachstum. Werte um 1 gelten oft als fair,
                            unter 1 als attraktiv.
                        </p>
                    </div>
                    <div class="bg-slate-950/60 border border-slate-800 rounded-xl p-4">
                        <h3 class="text-xs font-bold uppercase tracking-[0.25em] text-slate-500 mb-1">Market Cap</h3>
                        <p data-i18n="glossary.mcap">
                            Marktkapitalisierung = Aktienkurs √ó Anzahl Aktien. Zeigt, wie gro√ü ein Unternehmen an
                            der B√∂rse bewertet ist.
                        </p>
                    </div>
                    <div class="bg-slate-950/60 border border-slate-800 rounded-xl p-4">
                        <h3 class="text-xs font-bold uppercase tracking-[0.25em] text-slate-500 mb-1">Revenue Growth
                        </h3>
                        <p data-i18n="glossary.revgrowth">
                            Prozentuales Umsatzwachstum im Vergleich zum Vorjahr. Positives Wachstum ist meist ein gutes
                            Zeichen.
                        </p>
                    </div>
                    <div class="bg-slate-950/60 border border-slate-800 rounded-xl p-4">
                        <h3 class="text-xs font-bold uppercase tracking-[0.25em] text-slate-500 mb-1">Net Margin</h3>
                        <p data-i18n="glossary.netmargin">
                            Netto-Marge = Gewinn nach allen Kosten im Verh√§ltnis zum Umsatz.
                            H√∂here Margen bedeuten meist h√∂here Profitabilit√§t.
                        </p>
                    </div>
                    <div class="bg-slate-950/60 border border-slate-800 rounded-xl p-4">
                        <h3 class="text-xs font-bold uppercase tracking-[0.25em] text-slate-500 mb-1">EPS</h3>
                        <p data-i18n="glossary.eps">
                            Earnings per Share ‚Äì Gewinn je Aktie. Wichtige Basisgr√∂√üe f√ºr Bewertungskennzahlen wie das
                            KGV.
                        </p>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer class="text-center text-xs text-slate-500 py-6">
        ValueRadar Terminal v2.0 ‚Ä¢ Data provided by Yahoo Finance & Custom API
    </footer>

    <script>
        lucide.createIcons();

        /* ---------- THEME ---------- */

        function toggleTheme() {
            const html = document.documentElement;
            const body = document.body;
            const nowDark = html.classList.toggle('dark');
            body.classList.toggle('light', !nowDark);

            const icon = document.getElementById('theme-icon');
            icon.setAttribute('data-lucide', nowDark ? 'moon' : 'sun');
            lucide.createIcons();
        }

        /* ---------- I18N ---------- */

        let currentLang = localStorage.getItem('vr_lang') || 'de';

        const translations = {
            de: {
                'header.back': 'Zur√ºck',
                'header.live': 'Live',
                'header.scan': 'Scan: Global Undervalued Watchlist',
                'header.account': 'Account',
                'header.liveprice': 'Live Price',
                'region.all': 'Alle',
                'region.us': 'US',
                'region.de': 'DE',
                'region.fav': 'Watchlist',
                'tab.dashboard': 'Dashboard',
                'tab.glossary': 'Erkl√§rungen',
                'watchlist.title': 'Watchlist',
                'watchlist.subtitle': 'Global Undervalued Stocks',
                'kpi.pe': 'KGV (PE)',
                'kpi.peg': 'PEG Ratio',
                'kpi.mcap': 'Market Cap',
                'kpi.margin': 'Margins',
                'kpi.analyst': 'Analyst Rating',
                'kpi.vrscore': 'VR Score',
                'chart.title': 'Price Action',
                'fin.title': 'Financials (Est.)',
                'fin.revgrowth': 'Revenue Growth',
                'fin.netmargin': 'Net Margin',
                'sentiment.title': 'Sentiment',
                'sentiment.label': 'Strong Buy',
                'sentiment.subtitle': 'Based on technical & valuation factors',
                'sentiment.keydrivers': 'Key Drivers',
                'news.title': 'Aktuelle News',
                'news.loading': 'Lade Nachrichten...',
                'strengths.title': 'St√§rken',
                'strengths.subtitle': 'Warum die Aktie interessant ist',
                'strengths.loading': 'Lade St√§rken...',
                'risks.title': 'Risiken',
                'risks.subtitle': 'Worauf du achten solltest',
                'risks.loading': 'Lade Risiken...',
                'glossary.heading': 'Erkl√§rungen der Kennzahlen',
                'glossary.pe': 'Das Kurs-Gewinn-Verh√§ltnis vergleicht den Aktienkurs mit dem Gewinn pro Aktie. Niedriger ist grunds√§tzlich g√ºnstiger, h√§ngt aber stark vom Sektor ab.',
                'glossary.peg': 'Bewertet das KGV im Verh√§ltnis zum Gewinnwachstum. Werte um 1 gelten oft als fair, unter 1 als attraktiv.',
                'glossary.mcap': 'Marktkapitalisierung = Aktienkurs √ó Anzahl Aktien. Zeigt, wie gro√ü ein Unternehmen an der B√∂rse bewertet ist.',
                'glossary.revgrowth': 'Prozentuales Umsatzwachstum im Vergleich zum Vorjahr. Positives Wachstum ist meist ein gutes Zeichen.',
                'glossary.netmargin': 'Netto-Marge = Gewinn nach allen Kosten im Verh√§ltnis zum Umsatz. H√∂here Margen bedeuten meist h√∂here Profitabilit√§t.',
                'glossary.eps': 'Gewinn je Aktie. Basisgr√∂√üe f√ºr viele Bewertungskennzahlen.'
            },
            en: {
                'header.back': 'Back',
                'header.live': 'Live',
                'header.scan': 'Scan: Global undervalued watchlist',
                'header.account': 'Account',
                'header.liveprice': 'Live price',
                'region.all': 'All',
                'region.us': 'US',
                'region.de': 'DE',
                'region.fav': 'Watchlist',
                'tab.dashboard': 'Dashboard',
                'tab.glossary': 'Glossary',
                'watchlist.title': 'Watchlist',
                'watchlist.subtitle': 'Global undervalued stocks',
                'kpi.pe': 'P/E Ratio',
                'kpi.peg': 'PEG Ratio',
                'kpi.mcap': 'Market cap',
                'kpi.margin': 'Margins',
                'kpi.analyst': 'Analyst rating',
                'kpi.vrscore': 'VR score',
                'chart.title': 'Price action',
                'fin.title': 'Financials (est.)',
                'fin.revgrowth': 'Revenue growth',
                'fin.netmargin': 'Net margin',
                'sentiment.title': 'Sentiment',
                'sentiment.label': 'Strong buy',
                'sentiment.subtitle': 'Based on technical & valuation factors',
                'sentiment.keydrivers': 'Key drivers',
                'news.title': 'Latest news',
                'news.loading': 'Loading news...',
                'strengths.title': 'Strengths',
                'strengths.subtitle': 'Why this stock is interesting',
                'strengths.loading': 'Loading strengths...',
                'risks.title': 'Risks',
                'risks.subtitle': 'What to watch out for',
                'risks.loading': 'Loading risks...',
                'glossary.heading': 'Explanation of metrics',
                'glossary.pe': 'Price/earnings compares the stock price to earnings per share.',
                'glossary.peg': 'PEG relates the P/E to growth. Around 1 is often considered fair.',
                'glossary.mcap': 'Market cap = share price √ó shares outstanding.',
                'glossary.revgrowth': 'Year-over-year growth in revenue.',
                'glossary.netmargin': 'Net income divided by revenue.',
                'glossary.eps': 'Earnings per share ‚Äì profit per share.'
            }
        };

        function applyTranslations() {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.dataset.i18n;
                const t = translations[currentLang] && translations[currentLang][key];
                if (t) el.innerText = t;
            });

            const search = document.getElementById('global-search');
            if (search) {
                search.placeholder = currentLang === 'de' ? 'Suche Aktie...' : 'Search stock...';
            }
        }

        function setLang(lang) {
            if (!translations[lang]) return;
            currentLang = lang;
            localStorage.setItem('vr_lang', lang);

            const deBtn = document.getElementById('btn-lang-de');
            const enBtn = document.getElementById('btn-lang-en');

            deBtn.classList.toggle('bg-slate-800', lang === 'de');
            deBtn.classList.toggle('text-emerald-400', lang === 'de');
            enBtn.classList.toggle('bg-slate-800', lang === 'en');
            enBtn.classList.toggle('text-emerald-400', lang === 'en');

            applyTranslations();
        }

        /* ---------- VIEW SWITCH ---------- */

        function switchView(view) {
            const dash = document.getElementById('view-dashboard');
            const gloss = document.getElementById('view-glossary');
            const tabDash = document.getElementById('tab-dashboard');
            const tabGloss = document.getElementById('tab-glossary');

            if (view === 'glossary') {
                dash.classList.add('hidden');
                gloss.classList.remove('hidden');

                tabDash.classList.remove('bg-slate-800', 'text-emerald-400');
                tabDash.classList.add('text-slate-400');
                tabGloss.classList.add('bg-slate-800', 'text-emerald-400');
                tabGloss.classList.remove('text-slate-400');
            } else {
                gloss.classList.add('hidden');
                dash.classList.remove('hidden');

                tabGloss.classList.remove('bg-slate-800', 'text-emerald-400');
                tabGloss.classList.add('text-slate-400');
                tabDash.classList.add('bg-slate-800', 'text-emerald-400');
                tabDash.classList.remove('text-slate-400');
            }

            lucide.createIcons();
        }

        /* ---------- GLOBAL STATE ---------- */

        let fullList = [];
        let filteredList = [];
        let currentSymbol = "";
        let currentPrice = 100;
        let chart = null;
        let finChart = null;
        let gaugeChart = null;
        let abortController = new AbortController();
        let currentTimeframe = '1Y';
        let lastHistoryData = null;
        let showMA20 = true;
        let showMA50 = false;
        let showMA200 = false;

        /* ---------- WATCHLIST (localStorage) ---------- */

        function getFavorites() {
            try {
                return JSON.parse(localStorage.getItem('vr_favorites') || '[]');
            } catch {
                return [];
            }
        }

        function saveFavorites(list) {
            localStorage.setItem('vr_favorites', JSON.stringify(list));
        }

        function toggleFavorite(ev, symbol) {
            ev.stopPropagation();
            let favs = getFavorites();
            if (favs.includes(symbol)) {
                favs = favs.filter(s => s !== symbol);
            } else {
                favs.push(symbol);
            }
            saveFavorites(favs);
            renderStockList();
        }

        async function addSymbolToWatchlist() {
            let sym = prompt(currentLang === 'de'
                ? 'Gib das Tickersymbol ein (z.B. AAPL):'
                : 'Enter ticker symbol (e.g. AAPL):');
            if (!sym) return;
            sym = sym.trim().toUpperCase();
            if (!sym) return;

            if (fullList.some(s => (s.Symbol || s.symbol || '').toUpperCase() === sym)) {
                alert(currentLang === 'de'
                    ? 'Symbol ist bereits in der Liste.'
                    : 'Symbol is already in the list.');
                return;
            }

            try {
                const r = await fetch(`/api/details/${sym}`);
                const d = await r.json();
                if (d.error) throw new Error(d.error);

                let region = 'US';
                if ((d.country || '').includes('Germany')) region = 'DE';

                const newItem = {
                    Symbol: sym,
                    Name: d.name || sym,
                    Region: region,
                    Price: d.price_now || 0,
                    Reason: currentLang === 'de' ? 'Manuell hinzugef√ºgt' : 'Added manually'
                };
                fullList.push(newItem);

                let favs = getFavorites();
                if (!favs.includes(sym)) {
                    favs.push(sym);
                    saveFavorites(favs);
                }

                filterStocks('ALL');
                const idx = filteredList.findIndex(s => (s.Symbol || s.symbol) === sym);
                if (idx >= 0) selectStock(filteredList[idx], idx);
            } catch (e) {
                console.error(e);
                alert(currentLang === 'de'
                    ? 'Symbol konnte nicht geladen werden. Pr√ºfe den Ticker.'
                    : 'Could not load symbol. Please check the ticker.');
            }
        }

        /* ---------- HELPERS ---------- */

        function formatNumber(num) {
            if (num == null) return 'N/A';
            if (num >= 1e12) return (num / 1e12).toFixed(1) + 'T';
            if (num >= 1e9) return (num / 1e9).toFixed(1) + 'B';
            if (num >= 1e6) return (num / 1e6).toFixed(1) + 'M';
            return num.toLocaleString('en-US', { maximumFractionDigits: 0 });
        }

        /* ---------- INITIAL LOAD ---------- */

        fetch('/api/stocks')
            .then(r => r.json())
            .then(d => {
                fullList = d;
                if (!fullList || fullList.length === 0) {
                    fullList = [
                        { Symbol: 'AAPL', Name: 'Apple Inc.', Region: 'US', Price: 175.50 },
                        { Symbol: 'SAP', Name: 'SAP SE', Region: 'DE', Price: 140.20 },
                        { Symbol: 'TSLA', Name: 'Tesla Inc.', Region: 'US', Price: 210.00 }
                    ];
                }
                filterStocks('ALL');
            });

        /* ---------- FILTER FUNCTIONS ---------- */

        function filterDropdown(query) {
            const activeRegionBtn = document.querySelector('.region-btn.active-region');
            const currentReg = activeRegionBtn ? activeRegionBtn.dataset.reg : 'ALL';

            let list = fullList;

            if (currentReg === 'FAV') {
                const favs = getFavorites();
                list = list.filter(s => favs.includes(s.Symbol || s.symbol));
            } else if (currentReg !== 'ALL') {
                list = list.filter(
                    s => (s.region || s.Region || "US").toUpperCase() === currentReg
                );
            }

            if (query) {
                const lowerQ = query.toLowerCase();
                list = list.filter(s =>
                    (s.Name && s.Name.toLowerCase().includes(lowerQ)) ||
                    (s.Symbol && s.Symbol.toLowerCase().includes(lowerQ))
                );
            }

            filteredList = list;
            renderStockList();
        }

        function filterStocks(reg) {
            document.querySelectorAll('.region-btn').forEach(b => {
                b.classList.remove('active-region');
            });
            const btn = document.querySelector(`.region-btn[data-reg="${reg}"]`);
            if (btn) btn.classList.add('active-region');

            if (reg === 'FAV') {
                const favs = getFavorites();
                filteredList = fullList.filter(s => favs.includes(s.Symbol || s.symbol));
            } else if (reg === 'ALL') {
                filteredList = fullList;
            } else {
                filteredList = fullList.filter(
                    s => (s.Region || s.region || "US").toUpperCase() === reg
                );
            }

            renderStockList();
        }

        function filterStocksByName(query) {
            query = (query || "").toLowerCase();
            const activeRegionBtn = document.querySelector('.region-btn.active-region');
            const currentReg = activeRegionBtn ? activeRegionBtn.dataset.reg : 'ALL';

            let list = fullList;

            if (currentReg === 'FAV') {
                const favs = getFavorites();
                list = list.filter(s => favs.includes(s.Symbol || s.symbol));
            } else if (currentReg !== 'ALL') {
                list = list.filter(
                    s => (s.Region || s.region || "US").toUpperCase() === currentReg
                );
            }

            if (query) {
                list = list.filter(s =>
                    (s.Name && s.Name.toLowerCase().includes(query)) ||
                    (s.Symbol && s.Symbol.toLowerCase().includes(query))
                );
            }

            filteredList = list;
            renderStockList();
        }

        /* ---------- WATCHLIST RENDER ---------- */

        function renderStockList() {
            const container = document.getElementById('watchlist-container');
            container.innerHTML = '';

            if (!filteredList || filteredList.length === 0) {
                container.innerHTML = '<div class="p-4 text-xs text-slate-500 text-center">Keine Eintr√§ge gefunden.</div>';
                document.getElementById('watchlist-count').innerText = '0 Aktien';
                return;
            }

            const favs = getFavorites();

            filteredList.forEach((s, idx) => {
                const symbol = s.Symbol || s.symbol;
                const isFav = favs.includes(symbol);

                const row = document.createElement('button');
                row.className = "w-full text-left px-3 py-2.5 hover:bg-slate-900/80 transition flex items-center justify-between gap-3 text-xs border-b border-slate-800/60";
                row.onclick = () => selectStock(s, idx);

                const left = document.createElement('div');
                left.className = "min-w-0 flex-1";

                const title = document.createElement('div');
                title.className = "flex items-center gap-2";

                title.innerHTML = `
                <button class="p-0.5 mr-1 text-slate-500 hover:text-amber-400" onclick="toggleFavorite(event, '${symbol}')">
                    <i data-lucide="star" class="w-3 h-3 ${isFav ? 'text-amber-400 fill-amber-400' : ''}" data-symbol="${symbol}"></i>
                </button>
                <span class="font-semibold text-slate-100 truncate max-w-[140px]">${s.Name || s.name || symbol}</span>
                <span class="text-[10px] font-mono text-slate-500">${symbol}</span>
                <span class="text-[9px] text-slate-500 bg-slate-900 px-1.5 py-0.5 rounded-full border border-slate-800">${s.Region || s.region || "US"}</span>
            `;

                const reason = document.createElement('div');
                reason.className = "text-[10px] text-slate-500 truncate max-w-[220px]";
                reason.textContent = s.Reason || s.reason || "No description";

                left.appendChild(title);
                left.appendChild(reason);

                const right = document.createElement('div');
                right.className = "text-right flex flex-col items-end gap-0.5";
                const price = parseFloat(s.Price || s.price || 0).toFixed(2);
                currentPrice = parseFloat(price);
                right.innerHTML = `
                <div class="text-sm font-semibold text-slate-100">$${price}</div>
                <div class="text-[10px] text-emerald-400 flex items-center gap-1">
                    <i data-lucide="sparkles" class="w-3 h-3"></i>
                    <span>Underpriced</span>
                </div>
            `;

                row.appendChild(left);
                row.appendChild(right);
                container.appendChild(row);
            });

            document.getElementById('watchlist-count').innerText = `${filteredList.length} Aktien`;

            if (filteredList.length > 0 && !currentSymbol) {
                selectStock(filteredList[0], 0);
            }

            lucide.createIcons();
        }

        /* ---------- STOCK SELECTION + DETAILS ---------- */

        function selectStock(s, idx) {
            const rows = document.querySelectorAll('#watchlist-container > button');
            rows.forEach((r, i) => {
                r.classList.toggle('watch-row-active', i === idx);
            });

            currentSymbol = s.Symbol || s.symbol;
            currentPrice = parseFloat(s.Price || s.price || 0);

            document.getElementById('header-name').innerText = s.Name || s.name;
            document.getElementById('badge-ticker').innerText = currentSymbol;
            document.getElementById('badge-region').innerText = s.Region || s.region || "US";
            document.getElementById('header-price').innerText = "$" + parseFloat(currentPrice).toFixed(2);
            document.getElementById('yahoo-link').href = `https://finance.yahoo.com/quote/${currentSymbol}`;

            let pe = s.kgv || s.pe || s.trailingpe || "N/A";
            document.getElementById('kpi-pe').innerText = (typeof pe === 'number') ? pe.toFixed(2) : pe;

            let peg = s.peg || s.pgratio || s.pegratio || "N/A";
            const pegEl = document.getElementById('kpi-peg');
            pegEl.innerText = peg;
            const pegNum = parseFloat(peg);
            if (!isNaN(pegNum)) {
                if (pegNum < 1) pegEl.className = "text-xl font-bold text-emerald-400";
                else if (pegNum > 2) pegEl.className = "text-xl font-bold text-rose-400";
                else pegEl.className = "text-xl font-bold text-yellow-400";
            } else {
                pegEl.className = "text-xl font-bold text-white";
            }

            updateChart(currentTimeframe);
            loadDetails(currentSymbol);
            renderFinancialChart();
            renderGauge(Math.floor(Math.random() * 40) + 60);
        }

        async function loadDetails(sym) {
            try {
                const r = await fetch(`/api/details/${sym}`);
                const d = await r.json();

                if (d.error) {
                    console.log("Details error:", d.error);
                    return;
                }

                document.getElementById('header-industry').innerText = d.industry || '-';
                document.getElementById('header-sector').innerText = d.sector || '-';

                if (d.pe != null) {
                    const peEl = document.getElementById('kpi-pe');
                    peEl.innerText = d.pe.toFixed(2);
                }

                if (d.peg != null) {
                    const pegEl = document.getElementById('kpi-peg');
                    const pegNum = d.peg;
                    pegEl.innerText = pegNum.toFixed(2);

                    if (pegNum < 1) pegEl.className = "text-xl font-bold text-emerald-400";
                    else if (pegNum > 2) pegEl.className = "text-xl font-bold text-rose-400";
                    else pegEl.className = "text-xl font-bold text-yellow-400";
                }

                const mcEl = document.getElementById('kpi-mcap');
                if (mcEl) mcEl.innerText = d.market_cap ? formatNumber(d.market_cap) : 'N/A';

                const marginEl = document.getElementById('kpi-margin');
                if (marginEl) {
                    marginEl.innerText = d.profit_margin != null
                        ? (d.profit_margin * 100).toFixed(1) + '%'
                        : 'N/A';
                }

                const rgEl = document.getElementById('kpi-revgrowth');
                if (rgEl) {
                    rgEl.innerText = d.revenue_growth != null
                        ? (d.revenue_growth * 100).toFixed(1) + '%'
                        : 'N/A';
                }

                const nmEl = document.getElementById('kpi-netmargin');
                if (nmEl) {
                    nmEl.innerText = d.profit_margin != null
                        ? (d.profit_margin * 100).toFixed(1) + '%'
                        : 'N/A';
                }

                const nContainer = document.getElementById('news-container');
                const validNews = (d.news || []).filter(
                    n => n.title && n.publisher && n.link
                );

                if (validNews.length) {
                    nContainer.innerHTML = validNews.map(n => `
                    <a href="${n.link}" target="_blank"
                       class="flex flex-col border-b border-slate-800 pb-3 last:border-0
                              hover:bg-slate-800/50 p-2 rounded transition group">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-[10px] text-emerald-400 font-bold
                                         bg-emerald-500/10 px-2 py-0.5 rounded
                                         border border-emerald-500/20">
                                ${n.publisher}
                            </span>
                            <span class="text-[10px] text-slate-500">${n.date || ''}</span>
                        </div>
                        <h4 class="text-sm text-slate-200 group-hover:text-emerald-400
                                   transition font-medium leading-tight">
                            ${n.title}
                        </h4>
                    </a>
                `).join('');
                } else {
                    nContainer.innerHTML =
                        `<div class="text-slate-500 text-sm italic p-2">${currentLang === 'de' ? 'Keine aktuellen Nachrichten.' : 'No current news.'}</div>`;
                }

                const miniPros = document.getElementById('mini-pros-list');
                if (d.pros && d.pros.length) {
                    miniPros.innerHTML = d.pros.slice(0, 3)
                        .map(p => `<li>‚Ä¢ ${p}</li>`).join('');
                } else {
                    miniPros.innerHTML = '<li>--</li>';
                }

                const strengthsEl = document.getElementById('strengths-list');
                const risksEl = document.getElementById('risks-list');

                if (strengthsEl) {
                    if (d.pros && d.pros.length) {
                        strengthsEl.innerHTML = d.pros
                            .map(p => `<li>‚Ä¢ ${p}</li>`).join('');
                    } else {
                        strengthsEl.innerHTML = `<li class="text-slate-500 text-sm">${currentLang === 'de' ? 'Keine St√§rken verf√ºgbar.' : 'No strengths available.'}</li>`;
                    }
                }

                if (risksEl) {
                    if (d.risks && d.risks.length) {
                        risksEl.innerHTML = d.risks
                            .map(r => `<li>‚Ä¢ ${r}</li>`).join('');
                    } else {
                        risksEl.innerHTML = `<li class="text-slate-500 text-sm">${currentLang === 'de' ? 'Keine Risiken verf√ºgbar.' : 'No risks available.'}</li>`;
                    }
                }

            } catch (e) {
                console.log("Details fetch error:", e);
            }
        }

        /* ---------- CHARTS ---------- */

        async function updateChart(tf) {
            currentTimeframe = tf;

            document.querySelectorAll('.tf-btn').forEach(b => {
                b.classList.remove('active-tf');
                b.classList.add('text-slate-400', 'hover:bg-slate-800');
                if (b.innerText === tf) {
                    b.classList.add('active-tf');
                    b.classList.remove('text-slate-400', 'hover:bg-slate-800');
                }
            });

            if (abortController) abortController.abort();
            abortController = new AbortController();

            let data = null;
            try {
                const r = await fetch(`/api/history/${currentSymbol}/${tf}`, { signal: abortController.signal });
                const json = await r.json();
                if (!json.error && json.candle && json.candle.length > 0) {
                    data = json;
                } else {
                    throw new Error("Empty Data");
                }
            } catch (e) {
                if (e.name === 'AbortError') return;
                console.warn("Nutze Fallback-Chart Daten");
                data = generateFallbackData(tf, currentPrice);
            }

            lastHistoryData = data;
            renderMainChart(lastHistoryData);
        }

        function updateTimeframe(tf) {
            updateChart(tf);
        }

        function renderMainChart(d) {
            if (!d || !d.candle) return;

            const priceSeries = d.candle.map(x => ({ x: x[0], y: x[4] }));

            const series = [
                { name: 'Price', data: priceSeries }
            ];

            if (showMA20 && d.ma20 && d.ma20.length) {
                series.push({ name: 'MA 20', data: d.ma20 });
            }
            if (showMA50 && d.ma50 && d.ma50.length) {
                series.push({ name: 'MA 50', data: d.ma50 });
            }
            if (showMA200 && d.ma200 && d.ma200.length) {
                series.push({ name: 'MA 200', data: d.ma200 });
            }

            const options = {
                chart: {
                    type: 'line',
                    height: '100%',
                    fontFamily: 'Inter, system-ui, -apple-system, BlinkMacSystemFont',
                    toolbar: { show: false },
                    background: 'transparent',
                    animations: { enabled: false }
                },
                theme: { mode: 'dark' },
                series: series,
                colors: ['#10b981', '#3b82f6', '#f97316', '#e11d48'],
                stroke: { curve: 'smooth', width: 2 },
                dataLabels: { enabled: false },
                xaxis: {
                    type: 'datetime',
                    axisBorder: { show: false },
                    axisTicks: { show: false },
                    labels: {
                        style: {
                            colors: '#475569',
                            fontSize: '10px',
                            fontFamily: 'Inter, system-ui, -apple-system, BlinkMacSystemFont'
                        }
                    }
                },
                yaxis: {
                    labels: {
                        formatter: (v) => v.toFixed(0),
                        style: {
                            colors: '#475569',
                            fontSize: '10px',
                            fontFamily: 'Inter, system-ui, -apple-system, BlinkMacSystemFont'
                        },
                        offsetX: -6
                    }
                },
                grid: {
                    borderColor: '#0f172a',
                    strokeDashArray: 2,
                    padding: { top: 0, right: 4, bottom: 0, left: 4 }
                },
                tooltip: { theme: 'dark' },
                legend: { show: false }
            };

            if (chart) chart.destroy();
            chart = new ApexCharts(document.querySelector("#chart"), options);
            chart.render();
        }

        function toggleMA(len) {
            if (len === '20') showMA20 = !showMA20;
            if (len === '50') showMA50 = !showMA50;
            if (len === '200') showMA200 = !showMA200;

            document.querySelectorAll('.ma-btn').forEach(btn => {
                if (btn.dataset.ma === len) {
                    btn.classList.toggle('active-tf');
                    btn.classList.toggle('text-slate-400');
                }
            });

            if (lastHistoryData) {
                renderMainChart(lastHistoryData);
            }
        }

        function renderFinancialChart() {
            const options = {
                chart: {
                    type: 'bar',
                    height: 200,
                    toolbar: { show: false },
                    background: 'transparent',
                    stacked: true
                },
                theme: { mode: 'dark' },
                series: [
                    { name: 'Revenue', data: [10, 12, 14, 13, 15] },
                    { name: 'Net Income', data: [2, 3, 4, 3, 5] }
                ],
                plotOptions: {
                    bar: {
                        borderRadius: 4,
                        columnWidth: '45%'
                    }
                },
                dataLabels: { enabled: false },
                xaxis: {
                    categories: ['2020', '2021', '2022', '2023', '2024E'],
                    labels: {
                        style: { colors: '#64748b', fontSize: '11px' }
                    }
                },
                yaxis: {
                    labels: {
                        style: { colors: '#64748b', fontSize: '11px' }
                    }
                },
                colors: ['#22c55e', '#0ea5e9'],
                grid: { borderColor: '#1e293b', strokeDashArray: 3 },
                legend: { show: false },
                tooltip: { theme: 'dark' }
            };

            if (finChart) finChart.destroy();
            finChart = new ApexCharts(document.querySelector("#fin-chart"), options);
            finChart.render();
        }

        function renderGauge(val) {
            const options = {
                chart: {
                    height: 200,
                    type: 'radialBar',
                    toolbar: { show: false },
                    background: 'transparent'
                },
                series: [val],
                plotOptions: {
                    radialBar: {
                        startAngle: -135,
                        endAngle: 135,
                        hollow: {
                            size: '60%',
                            background: 'transparent'
                        },
                        track: {
                            background: '#020617',
                            strokeWidth: '100%'
                        },
                        dataLabels: {
                            name: {
                                show: true,
                                color: '#94a3b8',
                                fontSize: '11px',
                                offsetY: 40
                            },
                            value: {
                                formatter: function (val) {
                                    return parseInt(val) + "%";
                                },
                                color: '#e5e7eb',
                                fontSize: '24px',
                                fontWeight: 700,
                                offsetY: -10
                            }
                        }
                    }
                },
                fill: {
                    type: 'gradient',
                    gradient: {
                        shade: 'dark',
                        type: 'horizontal',
                        shadeIntensity: 0.5,
                        gradientToColors: ['#22c55e', '#0ea5e9'],
                        inverseColors: false,
                        opacityFrom: 1,
                        opacityTo: 1,
                        stops: [0, 50, 100]
                    }
                },
                stroke: {
                    lineCap: 'round'
                },
                labels: ['Score']
            };
            if (gaugeChart) gaugeChart.destroy();
            gaugeChart = new ApexCharts(document.querySelector("#gauge-chart"), options);
            gaugeChart.render();
        }

        function generateFallbackData(tf, price) {
            let points = 50;
            let now = new Date().getTime();
            let candles = [];
            let p = price;

            for (let i = 0; i < points; i++) {
                candles.unshift([now - (i * 86400000), p, p * (1.01), p * (0.99), p]);
                p = p * (1 + (Math.random() - 0.5) * 0.02);
            }

            return {
                candle: candles
            };
        }

        /* ---------- DOM READY ---------- */

        document.addEventListener('DOMContentLoaded', () => {
            // Sprache anwenden
            setLang(currentLang);

            // Account-Name aus localStorage anzeigen (Username > Email)
            const nameSpan = document.getElementById('account-name');
            if (nameSpan) {
                const username = localStorage.getItem('vrUsername');
                const email = localStorage.getItem('vrUserEmail');
                if (username) {
                    nameSpan.textContent = username;
                } else if (email) {
                    nameSpan.textContent = email;
                }
            }
        });
    </script>
</body>

</html>